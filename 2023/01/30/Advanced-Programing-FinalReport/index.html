<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 6.0.0">

<link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
  <link rel="apple-touch-icon" sizes="180x180" href="/images/32*32.ico">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/32*32.ico">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/16*16.ico">
  <link rel="mask-icon" href="/images/32*32.ico" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.15.4/css/all.min.css" integrity="sha256-mUZM63G8m73Mcidfrv5E+Y61y7a12O5mW4ezU3bxqW4=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/animate.css@3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.css" integrity="sha256-Vzbj7sDDS/woiFS3uNKo8eIuni59rjyNGtXfstRzStA=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"www.zhaoxuanlang.cn","root":"/","images":"/images","scheme":"Muse","darkmode":false,"version":"8.9.0","exturl":false,"sidebar":{"position":"left","display":"always","padding":18,"offset":12,"onmobile":true},"copycode":true,"bookmark":{"enable":true,"color":"#222","save":"manual"},"mediumzoom":false,"lazyload":true,"pangu":true,"comments":{"style":"tabs","active":"changyan","storage":true,"lazyload":false,"nav":null,"activeClass":"changyan"},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"},"path":"/search.xml","localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false}}</script><script src="/js/config.js"></script>
<meta name="description" content="Question 1: APPY: A simple parser generator Question 2: Stock Exchange Appendix">
<meta property="og:type" content="article">
<meta property="og:title" content="Advanced-Programing-FinalReport">
<meta property="og:url" content="https://www.zhaoxuanlang.cn/2023/01/30/Advanced-Programing-FinalReport/index.html">
<meta property="og:site_name" content="松鼠小筑">
<meta property="og:description" content="Question 1: APPY: A simple parser generator Question 2: Stock Exchange Appendix">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://i.imgur.com/QpDh4Bf.png">
<meta property="og:image" content="https://i.imgur.com/1SDfDey.png">
<meta property="article:published_time" content="2023-01-29T23:56:53.000Z">
<meta property="article:modified_time" content="2023-01-30T00:05:37.176Z">
<meta property="article:author" content="Xuanlang">
<meta property="article:tag" content="松鼠小筑">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://i.imgur.com/QpDh4Bf.png">


<link rel="canonical" href="https://www.zhaoxuanlang.cn/2023/01/30/Advanced-Programing-FinalReport/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-CN","comments":true,"permalink":"https://www.zhaoxuanlang.cn/2023/01/30/Advanced-Programing-FinalReport/","path":"2023/01/30/Advanced-Programing-FinalReport/","title":"Advanced-Programing-FinalReport"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>Advanced-Programing-FinalReport | 松鼠小筑</title>
  

  <script src="/js/third-party/analytics/baidu-analytics.js"></script>
  <script async src="https://hm.baidu.com/hm.js?2c6ad69c6dce83b3987864c3d69796db"></script>



  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">松鼠小筑</p>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">学习笔记</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu">
        <li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li>
        <li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签<span class="badge">23</span></a></li>
        <li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类<span class="badge">10</span></a></li>
        <li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档<span class="badge">85</span></a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup"><div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off" maxlength="80"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close" role="button">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="search-result-container no-result">
  <div class="search-result-icon">
    <i class="fa fa-spinner fa-pulse fa-5x"></i>
  </div>
</div>

    </div>
  </div>

</div>
        
  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>

  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link"><span class="nav-number">1.</span> <span class="nav-text">Question 1: APPY: A simple parser generator</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Question-1-1-The-Parser-module"><span class="nav-number">1.1.</span> <span class="nav-text">Question 1.1: The Parser module</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Design"><span class="nav-number">1.1.1.</span> <span class="nav-text">Design</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#implement"><span class="nav-number">1.1.2.</span> <span class="nav-text">implement</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Test"><span class="nav-number">1.1.3.</span> <span class="nav-text">Test</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Question-1-2-The-Transformer-module"><span class="nav-number">1.2.</span> <span class="nav-text">Question 1.2: The Transformer module</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link"><span class="nav-number">2.</span> <span class="nav-text">Question 2: Stock Exchange</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Question-2-1-The-erlst-module"><span class="nav-number">2.1.</span> <span class="nav-text">Question 2.1: The erlst module</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Topics"><span class="nav-number">2.1.1.</span> <span class="nav-text">Topics</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Design-2"><span class="nav-number">2.1.2.</span> <span class="nav-text">Design</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#implement-2"><span class="nav-number">2.1.3.</span> <span class="nav-text">implement</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Open-account"><span class="nav-number">2.1.3.1.</span> <span class="nav-text">Open_account</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Make-offer"><span class="nav-number">2.1.3.2.</span> <span class="nav-text">Make_offer</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Add-trader"><span class="nav-number">2.1.3.3.</span> <span class="nav-text">Add_trader</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#assessment"><span class="nav-number">2.1.4.</span> <span class="nav-text">assessment</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-2-Testing-erlst"><span class="nav-number">2.2.</span> <span class="nav-text">2.2 Testing erlst</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Topic"><span class="nav-number">2.2.1.</span> <span class="nav-text">Topic</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Design-3"><span class="nav-number">2.2.2.</span> <span class="nav-text">Design</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#assessment-2"><span class="nav-number">2.2.3.</span> <span class="nav-text">assessment</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link"><span class="nav-number">3.</span> <span class="nav-text">Appendix</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#ParserImpl"><span class="nav-number">3.1.</span> <span class="nav-text">ParserImpl</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#TransformerImpl"><span class="nav-number">3.2.</span> <span class="nav-text">TransformerImpl</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#BlackBox-hs"><span class="nav-number">3.3.</span> <span class="nav-text">BlackBox.hs</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#erlst-erl"><span class="nav-number">3.4.</span> <span class="nav-text">erlst.erl</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Test-erlst-unit-erl"><span class="nav-number">3.5.</span> <span class="nav-text">Test_erlst_unit.erl</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Test-erlst-erl"><span class="nav-number">3.6.</span> <span class="nav-text">Test_erlst.erl</span></a></li></ol></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author site-overview-item animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Xuanlang"
      src="/images/avatar.png">
  <p class="site-author-name" itemprop="name">Xuanlang</p>
  <div class="site-description" itemprop="description">业精于勤荒于嬉，行成于思毁于随</div>
</div>
<div class="site-state-wrap site-overview-item animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">85</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">10</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">23</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author site-overview-item animated">
      <span class="links-of-author-item">
        <a href="https://github.com/1982606762" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;1982606762" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:zxl17302206700@gmail.com" title="E-Mail → mailto:zxl17302206700@gmail.com" rel="noopener" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
  </div>
  <div class="cc-license site-overview-item animated" itemprop="license">
    <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" class="cc-opacity" rel="noopener" target="_blank"><img src="https://cdn.jsdelivr.net/npm/@creativecommons/vocabulary@2020.11.3/assets/license_badges/small/by_nc_sa.svg" alt="Creative Commons"></a>
  </div>



        </div>
      </div>
        <div class="back-to-top animated" role="button" aria-label="返回顶部">
          <i class="fa fa-arrow-up"></i>
          <span>0%</span>
        </div>
    </div>
  </aside>
  <div class="sidebar-dimmer"></div>


    </header>

    
  <div class="reading-progress-bar"></div>
  <a role="button" class="book-mark-link book-mark-link-fixed"></a>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://www.zhaoxuanlang.cn/2023/01/30/Advanced-Programing-FinalReport/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.png">
      <meta itemprop="name" content="Xuanlang">
      <meta itemprop="description" content="业精于勤荒于嬉，行成于思毁于随">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="松鼠小筑">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          Advanced-Programing-FinalReport
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>
      

      <time title="创建时间：2023-01-30 00:56:53 / 修改时间：01:05:37" itemprop="dateCreated datePublished" datetime="2023-01-30T00:56:53+01:00">2023-01-30</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/UCPH/" itemprop="url" rel="index"><span itemprop="name">UCPH</span></a>
        </span>
    </span>

  
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Changyan：</span>
    
    <a title="Advanced-Programing-FinalReport" href="/2023/01/30/Advanced-Programing-FinalReport/#SOHUCS" itemprop="discussionUrl">
      <span id="sourceId::9c16638c510e144b54101449130e6e5e" class="cy_cmt_count" itemprop="commentCount"></span>
    </a>
  </span>
  
  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>49k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>1:28</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
        <ul>
<li>Question 1: APPY: A simple parser generator</li>
<li>Question 2: Stock Exchange</li>
<li>Appendix</li>
</ul>
<span id="more"></span>
<h1>Question 1: APPY: A simple parser generator</h1>
<h2 id="Question-1-1-The-Parser-module"><a class="header-anchor" href="#Question-1-1-The-Parser-module">¶</a>Question 1.1: The Parser module</h2>
<h3 id="Design"><a class="header-anchor" href="#Design">¶</a>Design</h3>
<p>I first get rid of Left recursion and got the whole grammer as follows:</p>
<blockquote>
<p>Spec ::= preamble ERules.</p>
<p>ERules ::= ERule | ERule ERules.</p>
<p>ERule ::= LHS “::=” Alts “.”.</p>
<p>LHS ::= name OptType | “_”.</p>
<p>OptType ::= | “{:” htext “}”.</p>
<p>Alts ::= Seq | Seq “|” Alts.</p>
<p>Seq ::= Simple | Simplez “{” htext “}”.</p>
<p>Simplez ::= | Simple Simplez.</p>
<p>Simple ::= Simple0 | Simple0 “?” | Simple0 “*” | “!” Simple0.</p>
<p><em>– Simple0 ::= Atom Simple0’.</em></p>
<p><em>Simple0’ ::= | “{?” htext “}” Simple0</em></p>
<p>Atom ::= name | tokLit | “@” | charLit | “(” Alts “)”.</p>
</blockquote>
<h3 id="implement"><a class="header-anchor" href="#implement">¶</a>implement</h3>
<p>I implemented the parsers from top to bottom, just follow the grammar and write them.</p>
<p>First I implemented skipmore to skip spaces and comments, this part of the code I referenced from the 2021 exam sample code. Then I made token, symbol and schar from Parsernotes,  using skipmore in the token can make it skip spaces and comments before any token.</p>
<p>In parseLhs I used isUpper to check the head of the LHS name, if it’s Upper then it’s an RPlain, or it’s an RToken. So I just wrote them from parseErules to parseAtom. Then I made 4 small parsers to parse names (read a letter first and read a lot of letters,digit, and underscores),tokit(begin with double-quotes and end with double-quotes,I didn’t implement double double-quotes because I’m not quite sure how to judge if a double-quote is the ending of a TokLit or not),CharLit(begin with a single-quote and read a printable char and end with a single-quote),At(just return SAnyChar),parseHtext(read a lot of printable chars and end with ‘}’, I didn’t implement double ‘{’}’ because I’m also not sure how to judge if it’s an end or not).</p>
<p>Then, I implemented parsePreamble to read anything until it meets a ‘-’, and read “—\n” and return what it just read.</p>
<p>While developing I found that some of my grammers may generate ambiguous results, so I used the last result in parseSpec. It’s not the best way to handle it, but at least it can return the correct parsing answer.</p>
<h3 id="Test"><a class="header-anchor" href="#Test">¶</a>Test</h3>
<p>I made 34 unit tests for the parser, some of the results is failed because I didn’t implyment those part, such as complicated htext and tokLit with double-quotes inside.But the rest are all performing well and following is the test result:</p>
<p><img data-src="https://i.imgur.com/QpDh4Bf.png" alt="image-2022111131827454 AM"></p>
<h2 id="Question-1-2-The-Transformer-module"><a class="header-anchor" href="#Question-1-2-The-Transformer-module">¶</a>Question 1.2: The Transformer module</h2>
<p>I managed to implement a version of convert which can convert the test sample eg into g, it uses patton matching to get the rhs, and then I check the type of it, if it’s ESimple then I will return a list with AUser “”. If it’s a ESeq I’ll return the list generated by the helper function removeEsimple with Auser which is the second parameter of ESeq.If it’s a EBar, I first check the two parameters of EBar, if they are both ESeq I will return a list with two ESeq’s convert result.This simple convert function can successfully convert the sample eg into g.</p>
<h1>Question 2: Stock Exchange</h1>
<h2 id="Question-2-1-The-erlst-module"><a class="header-anchor" href="#Question-2-1-The-erlst-module">¶</a>Question 2.1: The erlst module</h2>
<h3 id="Topics"><a class="header-anchor" href="#Topics">¶</a>Topics</h3>
<ul>
<li>I support the complete API</li>
<li>My trader can only process one Strategy at a time, so it needs to be not so slow.</li>
<li>I uses 2 processes, one is the main exchange, one is the Strategy spawned process. Main exchange uses gen_server APIs to receive messages from user, Strategy send function result to main process through “!”</li>
<li>The data is shown below as the status</li>
<li>These parts are discussed in implement part</li>
</ul>
<h3 id="Design-2"><a class="header-anchor" href="#Design-2">¶</a>Design</h3>
<p>I read through the questions first and constructed the status of the system. As there’s 3 main data sets we need to save, I added 3 lists representing Accounts,Offers and Traders.Each Account has an account ID and a holding.</p>
<p>In designing account ID I found there’re some functions that don’t have server Pid as input, but have just an Acct. So I think AccountID needs to contain it’s server Pid, in that way it can get the server which this account was opened in, so the accountID is {S,Id}.For the Id part we need a unique id for each account, there’s multiple ways to do it, including setting a user count in state or generate a random unique number each time. I used the second one because I don’t want to add extra data in status which may result in the server running slow. I used erlang:now() to get the current time. I used erlang:localtime() first but during test I figured out that the minimum unit of time is seconds and if I call it several times by sequence erlang will do it in a second, and their ID will be the same. So I used now( ) instead although it’s been deprecated. I used lists: concat( )to concat ‘A’ and 3 results meaning it’s an accountID. Also I used the same code in generating OfferID and TraderID with initials of O and T.</p>
<p>In designing Offers as we need to store an accountID with the offer to do the money/ stock transfer later I added AccountID into the offer tuple. Also we need to add AccountID into Trader to do the following trades.</p>
<p>As we need to return the number of trades I also add a number into the status to count for it, I will discuss it later.</p>
<p>The following is the status I designed:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">State is [Num,Accounts, Offers, Traders]</span><br><span class="line">Num is the number of trades</span><br><span class="line">Accounts is [&#123;&#123;S,Id&#125;,&#123;isk,[&#123;stock,amount&#125;.....]&#125;&#125;....]</span><br><span class="line">*Offers is [&#123;OfferId,AccountId,&#123;stock,isk&#125;&#125;....]*</span><br><span class="line">*Traders is [&#123;TraderId,AccountId,Strategy&#125;....]*</span><br><span class="line">*Strategy = fun((Offer) -&gt; Decision)*</span><br></pre></td></tr></table></figure>
<h3 id="implement-2"><a class="header-anchor" href="#implement-2">¶</a>implement</h3>
<p>I used gen_server for the whole system and reviewed my code from assignment 6 to recall how to use APIs in gen_server.</p>
<h4 id="Open-account"><a class="header-anchor" href="#Open-account">¶</a>Open_account</h4>
<p>It will receive the server and new account’s holding and make a call to the server. Server will first generate an ID and use a helper function checkHoldings(Holdings).This function will check the input Holding if the ISK &gt;= 0. Then it will call another function checkStocks(). This function will check if each of the amounts &gt;=0. Then if checkHoldings return true we will reply it’s AcctID and also add this item into State.If it’s false we will return {error,badHoldings} to show it’s not a valid holding.</p>
<h4 id="Make-offer"><a class="header-anchor" href="#Make-offer">¶</a>Make_offer</h4>
<p>I used a helper function check_Account_exist to run account_balance with a given Id, and judge its result and return true or false. If it’s a valid Acct then we call the server with input Offer and Id from Acct. In server I first judge if the offer is a valid tuple, then if it’s valid we check if the offer’s price is valid.If all of these conditions are met we generate an OfferID and add the new offer into the state.</p>
<h4 id="Add-trader"><a class="header-anchor" href="#Add-trader">¶</a>Add_trader</h4>
<p>Then it comes the most complicated part of the server, the trader.</p>
<p>The task asked me to execute the trade whenever 4 conditions are met. I think we can define a function to execute each tradeable trade. As the 4 conditions may only be met when addoffer and addtrader is called, so I put the function above into handle_call of make_offer and add_trader.</p>
<p>My design of helper functions in doing this is as follows:</p>
<ul>
<li>check_offer_exists which will check if the offer list is empty.</li>
<li>run_strategy: run a strategy on a single offer. In this function I spawned a new process and in this process it runs the strategy over offer and sends back the result after the function gets the result to run_strategy process. And in the main time run_strategy receives the result and returns it. In this part I didn’t implement</li>
</ul>
<blockquote>
<p>“If a trader has accepted and is able to execute a trade, the stock exchange should execute the trade without waiting for the decisions of other—possibly slow—traders.”</p>
</blockquote>
<p>​				The reason of it is when I get the idea of doing it there’s not enough time for me to change the whole structure, I think it maybe can be solved by using lists:foreach for each Strategy to spawn a new process and send back the result, and the main process receive the fastest result and return it’s traderID and result.</p>
<ul>
<li>Map_offer:  use one trider run al offer, return a list of results the Trader made to each of the offers,which may looks like this: [accept,reject,accept…]. this list is called Map_Res.Here each result is a tuple, it’s look like {reject,Buyer,{OfferId,Seller,{Stock,Price}}}.With these info we can proceed to handle changing accounts.</li>
<li>Run_all_traders: use all traders to run all offer, each trader will return a list with result, so the function will return a list of result lists, which may looks like this:[[accept,reject],[reject,reject],[accept,accept]…],this list is called Map_Reses</li>
<li>Remove_offer: it will receive Map_Res and Offers, remove those offers which is accept in Map_Res.</li>
<li>Transfer_stock(Map_Res,Accounts): I used a helper function with 3 parameters in this <a target="_blank" rel="noopener" href="http://part.As">part.As</a> I remove offer based on Map_Res, sometimes Map_Res is accept, but the holdings of two side doesn’t meet the requirement, so although the trade was not exec,the offer is also got removed. So this function will return new Map_Res and new <a target="_blank" rel="noopener" href="http://Accounts.In">Accounts.In</a> helper function it has a new para NewMap_Res to collect each of new <a target="_blank" rel="noopener" href="http://results.In">results.In</a> this function it will go through each Map_Res, if it’s accept it will check buyer’s ISK and then seller’s stock, then do the transfer or do nothing to the Accounts list.</li>
<li>Run_all_Map_Res(Map_Reses,Accounts,Offers,Num):Recursive traversal Map_Reses and use above two functions to change Accounts and Offers. Also I changed the trade num by subtracting old Offers length with new Offers length and add the change to Original Num.Then it returns the final status after trading.</li>
</ul>
<h3 id="assessment"><a class="header-anchor" href="#assessment">¶</a>assessment</h3>
<ul>
<li>
<p>Completeness :I completed all the APIs</p>
</li>
<li>
<p>Correctness: I made 16 unit tests and 2 props and both passed(will discuss next)</p>
</li>
<li>
<p>Robustness: I made several robust upgrade to erlst after running eqc and unit test,including fixed a bug that change_stock may return a list with {error,aaa}inside, fixed several functions may crush when receiving a tuple.Before these my erlst crushes a lot when running prop test but now it doesn’t crush any more.However,because of time I didn’t implement the robust requirement, but I think both of them can be resolved with supervisor behavior.</p>
</li>
<li>
<p>Maintainability: I used a lot of helper functions in the code which makes it very easy to find bug and fix it. Also my code’s neatly arranged and each section has it’s name, like <em>Trader helper functions</em>,<em>server API</em> and so on.</p>
</li>
</ul>
<h2 id="2-2-Testing-erlst"><a class="header-anchor" href="#2-2-Testing-erlst">¶</a>2.2 Testing erlst</h2>
<h3 id="Topic"><a class="header-anchor" href="#Topic">¶</a>Topic</h3>
<ul>
<li>I had implemented all required parts</li>
</ul>
<h3 id="Design-3"><a class="header-anchor" href="#Design-3">¶</a>Design</h3>
<p>I implemented the function mkstrategy with 4 possible choices:{buy_everything,buy_cheap,buy_only,both}and each of them can return a strategy <a target="_blank" rel="noopener" href="http://function.in">function.in</a> both function it will only return accept when two functions generated by mkstrategy both return accept.</p>
<p>Then I implemented some other generators, stock_name can generate a name from[a,b,c,d,e,f], in stock_list,holdings and offer I used ?SUCHTHAT to check if the price &gt; 0, this can make sure they can generate legal ISK and prices.</p>
<p>Then I implemented reliable_strategy generator. It used oneof to generate a symbolic call from four choices regarding to four choices of mkstrategy.</p>
<p>Then I implemented prop_value_preservation().This prop I need to check the whole amount of money and stock, I first added two accounts, and each of then make 4 offers and 4 traders.And then check the money and stock. I used two helper functions calc_Total_Money and calc_Total_Stock to get current whole money and stock.Then I implemented prop_total_trades(), it also gen 2 accounts and each make 4 offers and 4 traders.Then the number of make_offer calls is 8 and number of trades is the number shutdown returns.</p>
<p>I also added 16 unit tests to test some aspects prop may not be able to reach, like negative ISK, negative stock price or offer price and so on, and my erlst passed all the tests.</p>
<p>Following is the result of testing:</p>
<p><img data-src="https://i.imgur.com/1SDfDey.png" alt="image-2022111124415659 AM"></p>
<h3 id="assessment-2"><a class="header-anchor" href="#assessment-2">¶</a>assessment</h3>
<ul>
<li>
<p>Completeness :I completed two props and some other helper functions</p>
</li>
<li>
<p>Correctness: I used the props to test my own erlst and found several bugs in my system until all tests passed.</p>
</li>
</ul>
<h1>Appendix</h1>
<h2 id="ParserImpl"><a class="header-anchor" href="#ParserImpl">¶</a>ParserImpl</h2>
<figure class="highlight haskell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- Put yor parser implementation in this file</span></span><br><span class="line"><span class="keyword">module</span> ParserImpl <span class="keyword">where</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> Definitions</span><br><span class="line"><span class="comment">-- import ReadP or Parsec</span></span><br><span class="line"><span class="keyword">import</span> Text.ParserCombinators.ReadP</span><br><span class="line"><span class="keyword">import</span> Control.Applicative ((&lt;|&gt;))</span><br><span class="line"><span class="keyword">import</span> Data.Char</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">type</span> <span class="type">Parser</span> a = <span class="type">ReadP</span> a</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">type</span> <span class="type">ParseError</span> = <span class="type">String</span></span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">-- Spec ::= preamble ERules.</span></span><br><span class="line"><span class="title">parseSpec</span> :: <span class="type">String</span> -&gt; <span class="type">EM</span> (<span class="type">String</span>, <span class="type">EGrammar</span>)</span><br><span class="line"><span class="title">parseSpec</span> str = <span class="keyword">case</span> readP_to_S (<span class="keyword">do</span></span><br><span class="line">  preamble &lt;- parsePreamble</span><br><span class="line">  eRules &lt;- parseErules</span><br><span class="line">  eof</span><br><span class="line">  return (preamble, eRules)) str <span class="keyword">of</span></span><br><span class="line">  [] -&gt; <span class="type">Left</span> <span class="string">&quot;Parse error&quot;</span></span><br><span class="line">  x -&gt; <span class="keyword">case</span> last x <span class="keyword">of</span></span><br><span class="line">    (x, <span class="string">&quot;&quot;</span>) -&gt; return x</span><br><span class="line">    _ -&gt; <span class="type">Left</span> <span class="string">&quot;Parse error&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="title">spec</span> :: <span class="type">Parser</span> (<span class="type">String</span>, <span class="type">EGrammar</span>)</span><br><span class="line"><span class="title">spec</span> = <span class="keyword">do</span></span><br><span class="line">    preamble &lt;- parsePreamble</span><br><span class="line">    eRules &lt;- parseErules</span><br><span class="line">    return (preamble, eRules)</span><br><span class="line"></span><br><span class="line"><span class="comment">-- ERules ::= ERule | ERule ERules.</span></span><br><span class="line"><span class="title">parseErules</span> :: <span class="type">Parser</span> [<span class="type">ERule</span>]</span><br><span class="line"><span class="title">parseErules</span> = <span class="keyword">do</span></span><br><span class="line">            skipmore        </span><br><span class="line">            e &lt;- parseErule</span><br><span class="line">            es &lt;- parseErules</span><br><span class="line">            return (e:es)</span><br><span class="line">        &lt;|&gt; <span class="keyword">do</span></span><br><span class="line">            e &lt;- parseErule</span><br><span class="line">            return [e]</span><br><span class="line"></span><br><span class="line"><span class="comment">-- ERule :: LHS &quot;::=&quot; Alts &quot;.&quot;.</span></span><br><span class="line"><span class="title">parseErule</span> :: <span class="type">Parser</span> <span class="type">ERule</span></span><br><span class="line"><span class="title">parseErule</span> = <span class="keyword">do</span></span><br><span class="line">            (l1,l2,l3) &lt;- parseLhs</span><br><span class="line">            symbol <span class="string">&quot;::=&quot;</span></span><br><span class="line">            a &lt;- parseAlts</span><br><span class="line">            schar &#x27;.&#x27;</span><br><span class="line">            return ((l1,l2,l3),a)</span><br><span class="line"></span><br><span class="line"><span class="comment">-- LHS ::= name OptType | &quot;_&quot;.</span></span><br><span class="line"><span class="title">parseLhs</span> :: <span class="type">Parser</span> <span class="type">RLHS</span></span><br><span class="line"><span class="title">parseLhs</span> = <span class="keyword">do</span></span><br><span class="line">        skipmore</span><br><span class="line">        n &lt;- parseName</span><br><span class="line">        o &lt;- parseOptType</span><br><span class="line">        <span class="keyword">if</span> isUpper (head n)</span><br><span class="line">            <span class="keyword">then</span> return (n, <span class="type">RPlain</span>, o)</span><br><span class="line">            <span class="keyword">else</span> return (n, <span class="type">RToken</span>, o)</span><br><span class="line">    &lt;|&gt; <span class="keyword">do</span></span><br><span class="line">        skipmore</span><br><span class="line">        symbol <span class="string">&quot;_&quot;</span></span><br><span class="line">        return (<span class="string">&quot;_&quot;</span>,<span class="type">RSep</span>,<span class="type">Nothing</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">-- OptType ::= | &quot;&#123;:&quot; htext &quot;&#125;&quot;.</span></span><br><span class="line"><span class="title">parseOptType</span> :: <span class="type">Parser</span> (<span class="type">Maybe</span> <span class="type">Type</span>)</span><br><span class="line"><span class="title">parseOptType</span> = <span class="keyword">do</span></span><br><span class="line">            schar &#x27;&#123;&#x27;</span><br><span class="line">            schar &#x27;:&#x27;</span><br><span class="line">            h &lt;- parseHtext</span><br><span class="line">            schar &#x27;&#125;&#x27;</span><br><span class="line">            return (<span class="type">Just</span> (<span class="type">AUser</span> h))</span><br><span class="line">        &lt;|&gt; return <span class="type">Nothing</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">-- Alts ::= Seq | Seq &quot;|&quot; Alts.</span></span><br><span class="line"><span class="title">parseAlts</span> :: <span class="type">Parser</span> <span class="type">ERHS</span></span><br><span class="line"><span class="title">parseAlts</span> = <span class="keyword">do</span></span><br><span class="line">        skipmore</span><br><span class="line">        s &lt;- parseSeq</span><br><span class="line">        symbol <span class="string">&quot;|&quot;</span></span><br><span class="line">        <span class="type">EBar</span> s &lt;$&gt; parseAlts</span><br><span class="line">       &lt;|&gt; <span class="keyword">do</span></span><br><span class="line">        skipmore</span><br><span class="line">        parseSeq</span><br><span class="line"></span><br><span class="line"><span class="comment">-- Seq ::= Simple | Simplez &quot;&#123;&quot; htext &quot;&#125;&quot;.</span></span><br><span class="line"><span class="title">parseSeq</span> :: <span class="type">Parser</span> <span class="type">ERHS</span></span><br><span class="line"><span class="title">parseSeq</span> = <span class="keyword">do</span></span><br><span class="line">        s &lt;- parseSimplez</span><br><span class="line">        schar &#x27;&#123;&#x27;</span><br><span class="line">        h &lt;- parseHtext</span><br><span class="line">        schar &#x27;&#125;&#x27;</span><br><span class="line">        return (<span class="type">ESeq</span> s h)</span><br><span class="line">    &lt;|&gt; parseSimple</span><br><span class="line"></span><br><span class="line"><span class="comment">-- Simplez ::= | Simple Simplez.</span></span><br><span class="line"><span class="title">parseSimplez</span> :: <span class="type">Parser</span> [<span class="type">ERHS</span>]</span><br><span class="line"><span class="title">parseSimplez</span> = <span class="keyword">do</span></span><br><span class="line">            s &lt;- parseSimple</span><br><span class="line">            ss &lt;- parseSimplez</span><br><span class="line">            return (s:ss)</span><br><span class="line">        &lt;|&gt; return []</span><br><span class="line"></span><br><span class="line"><span class="comment">-- Simple ::= Simple0 | Simple0 &quot;?&quot; | Simple0 &quot;*&quot; | &quot;!&quot; Simple0.</span></span><br><span class="line"><span class="title">parseSimple</span> :: <span class="type">Parser</span> <span class="type">ERHS</span></span><br><span class="line"><span class="title">parseSimple</span> = <span class="keyword">do</span></span><br><span class="line">            s &lt;- parseSimple0</span><br><span class="line">            schar &#x27;?&#x27;</span><br><span class="line">            return (<span class="type">EOption</span> s)</span><br><span class="line">        &lt;|&gt; <span class="keyword">do</span></span><br><span class="line">            s &lt;- parseSimple0</span><br><span class="line">            schar &#x27;*&#x27;</span><br><span class="line">            return (<span class="type">EMany</span> s)</span><br><span class="line">        &lt;|&gt; <span class="keyword">do</span></span><br><span class="line">            schar &#x27;!&#x27;</span><br><span class="line">            <span class="type">ENot</span> &lt;$&gt; parseSimple0</span><br><span class="line">        &lt;|&gt; parseSimple0</span><br><span class="line"></span><br><span class="line"><span class="comment">-- Simple0 ::= Atom Simple0&#x27;.</span></span><br><span class="line"><span class="title">parseSimple0</span> :: <span class="type">Parser</span> <span class="type">ERHS</span></span><br><span class="line"><span class="title">parseSimple0</span> = <span class="keyword">do</span></span><br><span class="line">            a &lt;- parseAtom</span><br><span class="line">            parseSimple0&#x27; a</span><br><span class="line"></span><br><span class="line"><span class="comment">-- Simple0&#x27; ::= | &quot;&#123;?&quot; htext &quot;&#125;&quot; Simple0&#x27;.</span></span><br><span class="line"><span class="title">parseSimple0&#x27;</span> :: <span class="type">ERHS</span> -&gt; <span class="type">Parser</span> <span class="type">ERHS</span></span><br><span class="line"><span class="title">parseSimple0&#x27;</span> a = <span class="keyword">do</span></span><br><span class="line">                schar &#x27;&#123;&#x27;</span><br><span class="line">                schar &#x27;?&#x27;</span><br><span class="line">                h &lt;- parseHtext</span><br><span class="line">                schar &#x27;&#125;&#x27;</span><br><span class="line">                parseSimple0&#x27; (<span class="type">EPred</span> a h)</span><br><span class="line">            &lt;|&gt; return a</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">-- Atom ::= name | tokLit | &quot;@&quot; | charLit | &quot;(&quot; Alts &quot;)&quot;.</span></span><br><span class="line"><span class="title">parseAtom</span> :: <span class="type">Parser</span> <span class="type">ERHS</span></span><br><span class="line"><span class="title">parseAtom</span> = <span class="keyword">do</span></span><br><span class="line">        <span class="type">ESimple</span> . <span class="type">SNTerm</span> &lt;$&gt; parseName</span><br><span class="line">    &lt;|&gt; <span class="keyword">do</span></span><br><span class="line">        <span class="type">ESimple</span> . <span class="type">SLit</span> &lt;$&gt; parseTokLit</span><br><span class="line">    &lt;|&gt; parseAt</span><br><span class="line">    &lt;|&gt; <span class="keyword">do</span></span><br><span class="line">        <span class="type">ESimple</span> . <span class="type">SChar</span> &lt;$&gt; parseCharLit</span><br><span class="line">    &lt;|&gt; <span class="keyword">do</span></span><br><span class="line">        schar &#x27;(&#x27;</span><br><span class="line">        a &lt;- parseAlts</span><br><span class="line">        schar &#x27;)&#x27;</span><br><span class="line">        return a</span><br><span class="line"></span><br><span class="line"><span class="title">parseName</span> :: <span class="type">Parser</span> <span class="type">String</span></span><br><span class="line"><span class="title">parseName</span> = token(<span class="keyword">do</span></span><br><span class="line">        c &lt;- satisfy isLetter</span><br><span class="line">        cs &lt;- munch (\c -&gt; isLetter c || isDigit c || c == &#x27;_&#x27;)</span><br><span class="line">        return (c:cs))</span><br><span class="line"></span><br><span class="line"><span class="title">parseTokLit</span> :: <span class="type">Parser</span> <span class="type">String</span></span><br><span class="line"><span class="title">parseTokLit</span> = token(<span class="keyword">do</span></span><br><span class="line">        schar &#x27;<span class="string">&quot;&#x27;</span></span><br><span class="line"><span class="string">        cs &lt;- munch (\c -&gt; c /= &#x27;&quot;</span>&#x27;)</span><br><span class="line">        schar &#x27;<span class="string">&quot;&#x27;</span></span><br><span class="line"><span class="string">        return cs)</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    </span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">parseCharLit :: Parser Char</span></span><br><span class="line"><span class="string">parseCharLit = do</span></span><br><span class="line"><span class="string">            schar &#x27;\&#x27;&#x27;</span></span><br><span class="line"><span class="string">            c &lt;- satisfy isPrint</span></span><br><span class="line"><span class="string">            schar &#x27;\&#x27;&#x27;</span></span><br><span class="line"><span class="string">            return c</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">parseAt :: Parser ERHS</span></span><br><span class="line"><span class="string">parseAt = do</span></span><br><span class="line"><span class="string">        schar &#x27;@&#x27;</span></span><br><span class="line"><span class="string">        return (ESimple SAnyChar)</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">parseHtext :: Parser String</span></span><br><span class="line"><span class="string">parseHtext = munch (\c -&gt; isPrint c  &amp;&amp; c /= &#x27;&#125;&#x27;)</span></span><br><span class="line"><span class="string">        </span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">parsePreamble :: Parser String</span></span><br><span class="line"><span class="string">parsePreamble = do</span></span><br><span class="line"><span class="string">    p &lt;- munch (/= &#x27;-&#x27;)</span></span><br><span class="line"><span class="string">    symbol &quot;</span><span class="comment">---\n&quot;</span></span><br><span class="line">    return p</span><br><span class="line"></span><br><span class="line"><span class="comment">-- reference from the last haskell lecture code</span></span><br><span class="line"><span class="title">skipmore</span> :: <span class="type">Parser</span> ()</span><br><span class="line"><span class="title">skipmore</span> = <span class="keyword">do</span></span><br><span class="line">    <span class="keyword">do</span> </span><br><span class="line">        skipSpaces;</span><br><span class="line">        optional (</span><br><span class="line">            <span class="keyword">do</span></span><br><span class="line">                string <span class="string">&quot;--&quot;</span>;</span><br><span class="line">                endComment;</span><br><span class="line">                skipmore</span><br><span class="line">            )</span><br><span class="line"><span class="title">endComment</span> :: <span class="type">Parser</span> ()</span><br><span class="line"><span class="title">endComment</span> = <span class="keyword">do</span></span><br><span class="line">    char &#x27;\n&#x27;</span><br><span class="line">    return ()</span><br><span class="line">    &lt;++ <span class="keyword">do</span></span><br><span class="line">        get;</span><br><span class="line">        endComment</span><br><span class="line">        </span><br><span class="line">    </span><br><span class="line"></span><br><span class="line"><span class="comment">-- Reference from Parsernotes</span></span><br><span class="line"><span class="title">token</span> :: <span class="type">Parser</span> a -&gt; <span class="type">Parser</span> a</span><br><span class="line"><span class="title">token</span> p = skipmore &gt;&gt; p</span><br><span class="line"><span class="title">symbol</span> :: <span class="type">String</span> -&gt; <span class="type">Parser</span> <span class="type">String</span></span><br><span class="line"><span class="title">symbol</span> = token . string</span><br><span class="line"><span class="title">schar</span> :: <span class="type">Char</span> -&gt; <span class="type">Parser</span> <span class="type">Char</span></span><br><span class="line"><span class="title">schar</span> = token . char</span><br></pre></td></tr></table></figure>
<h2 id="TransformerImpl"><a class="header-anchor" href="#TransformerImpl">¶</a>TransformerImpl</h2>
<figure class="highlight haskell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- Put yor transformer implementation in this file</span></span><br><span class="line"><span class="keyword">module</span> TransformerImpl <span class="keyword">where</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> Definitions</span><br><span class="line"></span><br><span class="line"><span class="title">convert</span> :: <span class="type">EGrammar</span> -&gt; <span class="type">EM</span> <span class="type">Grammar</span></span><br><span class="line"><span class="title">convert</span> [] = <span class="type">Right</span> []</span><br><span class="line"><span class="title">convert</span> [(lhs, rhs)] = <span class="keyword">case</span> rhs <span class="keyword">of</span></span><br><span class="line">    <span class="type">EBar</span> r1 r2 -&gt; <span class="keyword">case</span> (r1, r2) <span class="keyword">of</span> </span><br><span class="line">        (<span class="type">ESeq</span> s1 u1, <span class="type">ESeq</span> s2 u2) -&gt; <span class="type">Right</span> [(lhs, [(removeEsimple s1, <span class="type">AUser</span> u1), (removeEsimple s2, <span class="type">AUser</span> u2)])];</span><br><span class="line">        _ -&gt; <span class="type">Left</span> <span class="string">&quot;Error&quot;</span></span><br><span class="line">    <span class="type">ESeq</span> s u -&gt; <span class="type">Right</span> [(lhs, [(removeEsimple s, <span class="type">AUser</span> u)])]      </span><br><span class="line">    <span class="type">ESimple</span> s -&gt; <span class="type">Right</span> [(lhs, [([s], <span class="type">AUser</span> <span class="string">&quot;&quot;</span>)])]</span><br><span class="line">    _ -&gt; <span class="type">Left</span> <span class="string">&quot;Error&quot;</span></span><br><span class="line"><span class="title">convert</span> ((lhs, rhs):xs) = </span><br><span class="line">    <span class="keyword">case</span> convert [(lhs, rhs)] <span class="keyword">of</span></span><br><span class="line">        <span class="type">Right</span> r -&gt; <span class="keyword">case</span> convert xs <span class="keyword">of</span></span><br><span class="line">            <span class="type">Right</span> rs -&gt; <span class="type">Right</span> (r ++ rs)</span><br><span class="line">            <span class="type">Left</span> e -&gt; <span class="type">Left</span> e</span><br><span class="line">        <span class="type">Left</span> e -&gt; <span class="type">Left</span> e    </span><br><span class="line">    </span><br><span class="line"></span><br><span class="line"><span class="title">removeEsimple</span> :: [<span class="type">ERHS</span>] -&gt; [<span class="type">Simple</span>]</span><br><span class="line"><span class="title">removeEsimple</span> [] = []</span><br><span class="line"><span class="title">removeEsimple</span> (x:xs) = <span class="keyword">case</span> x <span class="keyword">of</span></span><br><span class="line">    <span class="type">ESimple</span> s -&gt; s : removeEsimple xs</span><br><span class="line"></span><br><span class="line">    </span><br><span class="line"><span class="title">lre</span> :: <span class="type">Grammar</span> -&gt; <span class="type">EM</span> <span class="type">Grammar</span></span><br><span class="line"><span class="title">lre</span> = undefined</span><br><span class="line"></span><br><span class="line"><span class="title">lfactor</span> :: <span class="type">Grammar</span> -&gt; <span class="type">EM</span> <span class="type">Grammar</span></span><br><span class="line"><span class="title">lfactor</span> = undefined</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h2 id="BlackBox-hs"><a class="header-anchor" href="#BlackBox-hs">¶</a>BlackBox.hs</h2>
<figure class="highlight haskell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- Sample black-box test suite. Feel free to adapt, or start from scratch.</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- Do NOT import from your ModImpl files here. These tests should work with</span></span><br><span class="line"><span class="comment">-- any implementation of the APpy APIs. Put any white-box tests in</span></span><br><span class="line"><span class="comment">-- suite1/WhiteBox.hs.</span></span><br><span class="line"><span class="keyword">import</span> Definitions</span><br><span class="line"><span class="keyword">import</span> Parser</span><br><span class="line"><span class="keyword">import</span> Transformer</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> Test.Tasty</span><br><span class="line"><span class="keyword">import</span> Test.Tasty.HUnit</span><br><span class="line"></span><br><span class="line"><span class="title">main</span> :: <span class="type">IO</span> ()</span><br><span class="line"><span class="title">main</span> = defaultMain $ localOption (mkTimeout <span class="number">1000000</span>) tests</span><br><span class="line"></span><br><span class="line"><span class="title">tests</span> = testGroup <span class="string">&quot;Smoke tests&quot;</span> [</span><br><span class="line">       testCase <span class="string">&quot;Parser&quot;</span> $ parseSpec str @?= <span class="type">Right</span> (<span class="string">&quot;&quot;</span>, eg),</span><br><span class="line">       testCase <span class="string">&quot;Test name1&quot;</span> $ parseSpec str1 @?= <span class="type">Right</span> (<span class="string">&quot;&quot;</span>, eg2),</span><br><span class="line">       testCase <span class="string">&quot;Test name2&quot;</span> $ parseSpec str2 @?= <span class="type">Right</span> (<span class="string">&quot;&quot;</span>, eg3),</span><br><span class="line">       testCase <span class="string">&quot;Test name3&quot;</span> $ parseSpec str3 @?= <span class="type">Right</span> (<span class="string">&quot;&quot;</span>, eg4),</span><br><span class="line">       testCase <span class="string">&quot;Test name4&quot;</span> $ parseSpec str4 @?= <span class="type">Left</span> <span class="string">&quot;Parse error&quot;</span>,</span><br><span class="line">       testCase <span class="string">&quot;Test Comment1&quot;</span> $ parseSpec str5 @?= <span class="type">Right</span> (<span class="string">&quot;&quot;</span>, eg5),</span><br><span class="line">       testCase <span class="string">&quot;Test Comment2&quot;</span> $ parseSpec str6 @?= <span class="type">Right</span> (<span class="string">&quot;&quot;</span>, eg6),</span><br><span class="line">       testCase <span class="string">&quot;Test Comment3&quot;</span> $ parseSpec str7 @?= <span class="type">Right</span> (<span class="string">&quot;&quot;</span>, eg7),</span><br><span class="line">       testCase <span class="string">&quot;Test tokLit1&quot;</span> $ parseSpec str8 @?= <span class="type">Right</span> (<span class="string">&quot;&quot;</span>, eg8),</span><br><span class="line">       testCase <span class="string">&quot;Test tokLit2&quot;</span> $ parseSpec str9 @?= <span class="type">Right</span> (<span class="string">&quot;&quot;</span>, eg9),</span><br><span class="line">       testCase <span class="string">&quot;Test tokLit3&quot;</span> $ parseSpec str10 @?= <span class="type">Left</span> <span class="string">&quot;Parse error&quot;</span>,</span><br><span class="line">       testCase <span class="string">&quot;Test CharLit1&quot;</span> $ parseSpec str11 @?= <span class="type">Right</span> (<span class="string">&quot;&quot;</span>, eg11),</span><br><span class="line">       testCase <span class="string">&quot;Test CharLit2&quot;</span> $ parseSpec str12 @?= <span class="type">Left</span> <span class="string">&quot;Parse error&quot;</span>,</span><br><span class="line">       testCase <span class="string">&quot;Test CharLit3&quot;</span> $ parseSpec str13 @?= <span class="type">Left</span> <span class="string">&quot;Parse error&quot;</span>,</span><br><span class="line">       testCase <span class="string">&quot;Test Atom1&quot;</span> $ parseSpec str14 @?= <span class="type">Right</span> (<span class="string">&quot;&quot;</span>, eg14),</span><br><span class="line">       testCase <span class="string">&quot;Test Atom2&quot;</span> $ parseSpec str15 @?= <span class="type">Right</span> (<span class="string">&quot;&quot;</span>, eg15),</span><br><span class="line">       testCase <span class="string">&quot;Test Atom3&quot;</span> $ parseSpec str16 @?= <span class="type">Right</span> (<span class="string">&quot;&quot;</span>, eg16),</span><br><span class="line">       testCase <span class="string">&quot;Test Simple01&quot;</span> $ parseSpec str17 @?= <span class="type">Right</span> (<span class="string">&quot;&quot;</span>, eg17),</span><br><span class="line">       testCase <span class="string">&quot;Test Simple02&quot;</span> $ parseSpec str18 @?= <span class="type">Right</span> (<span class="string">&quot;&quot;</span>, eg18),</span><br><span class="line">       testCase <span class="string">&quot;Test Simple03&quot;</span> $ parseSpec str19 @?= <span class="type">Right</span> (<span class="string">&quot;&quot;</span>, eg19),</span><br><span class="line">       testCase <span class="string">&quot;Test Simple1&quot;</span> $ parseSpec str20 @?= <span class="type">Right</span> (<span class="string">&quot;&quot;</span>, eg20),</span><br><span class="line">       testCase <span class="string">&quot;Test Simple2&quot;</span> $ parseSpec str21 @?= <span class="type">Right</span> (<span class="string">&quot;&quot;</span>, eg21),</span><br><span class="line">       testCase <span class="string">&quot;Test Simple3&quot;</span> $ parseSpec str22 @?= <span class="type">Right</span> (<span class="string">&quot;&quot;</span>, eg22),</span><br><span class="line">       testCase <span class="string">&quot;Test htext1&quot;</span> $ parseSpec str23 @?= <span class="type">Right</span> (<span class="string">&quot;&quot;</span>, eg23),</span><br><span class="line">       testCase <span class="string">&quot;Test htext2&quot;</span> $ parseSpec str24 @?= <span class="type">Right</span> (<span class="string">&quot;&quot;</span>, eg24),</span><br><span class="line">       testCase <span class="string">&quot;Test htext3&quot;</span> $ parseSpec str25 @?= <span class="type">Left</span> <span class="string">&quot;Parse error&quot;</span>,</span><br><span class="line">       testCase <span class="string">&quot;Test htext4&quot;</span> $ parseSpec str26 @?= <span class="type">Left</span> <span class="string">&quot;Parse error&quot;</span>,</span><br><span class="line">       testCase <span class="string">&quot;Test LHS1&quot;</span> $ parseSpec str27 @?= <span class="type">Right</span> (<span class="string">&quot;&quot;</span>, eg27),</span><br><span class="line">       testCase <span class="string">&quot;Test LHS2&quot;</span> $ parseSpec str28 @?= <span class="type">Right</span> (<span class="string">&quot;&quot;</span>, eg28),</span><br><span class="line">       testCase <span class="string">&quot;Test LHS3&quot;</span> $ parseSpec str29 @?= <span class="type">Right</span> (<span class="string">&quot;&quot;</span>, eg29),</span><br><span class="line">       testCase <span class="string">&quot;Test Preamble1&quot;</span> $ parseSpec str30 @?= <span class="type">Right</span> (<span class="string">&quot;asdasdasd&quot;</span>, eg30),</span><br><span class="line">       testCase <span class="string">&quot;Test Preamble2&quot;</span> $ parseSpec str31 @?= <span class="type">Right</span> (<span class="string">&quot;a s d a s d a s d &quot;</span>, eg31),</span><br><span class="line">       testCase <span class="string">&quot;Test Preamble3&quot;</span> $ parseSpec str32 @?= <span class="type">Right</span> (<span class="string">&quot;a s d a s d a s d &quot;</span>, eg32),</span><br><span class="line">       testCase <span class="string">&quot;Test ERules1&quot;</span> $ parseSpec str33 @?= <span class="type">Right</span> (<span class="string">&quot;&quot;</span>, eg33),</span><br><span class="line">       testCase <span class="string">&quot;Test convert&quot;</span> $ convert eg @?= <span class="type">Right</span> g</span><br><span class="line">       ]</span><br><span class="line">       <span class="comment">-- convert eg @?= Right g] -- assumes that convert preserves input rule order</span></span><br><span class="line">       <span class="keyword">where</span></span><br><span class="line">       str = <span class="string">&quot;---\n S ::= S \&quot;a\&quot; &#123;_1+1&#125; | \&quot;b\&quot; &#123;0&#125;.\n _ ::= &#123;()&#125;.&quot;</span></span><br><span class="line">       eg = [((<span class="string">&quot;S&quot;</span>, <span class="type">RPlain</span>, <span class="type">Nothing</span>),</span><br><span class="line">              <span class="type">EBar</span> (<span class="type">ESeq</span> [<span class="type">ESimple</span> (<span class="type">SNTerm</span> <span class="string">&quot;S&quot;</span>), <span class="type">ESimple</span> (<span class="type">SLit</span> <span class="string">&quot;a&quot;</span>)] <span class="string">&quot;_1+1&quot;</span>)</span><br><span class="line">                            (<span class="type">ESeq</span> [<span class="type">ESimple</span> (<span class="type">SLit</span> <span class="string">&quot;b&quot;</span>)] <span class="string">&quot;0&quot;</span>)),</span><br><span class="line">              ((<span class="string">&quot;_&quot;</span>, <span class="type">RSep</span>, <span class="type">Nothing</span>), <span class="type">ESeq</span> [] (<span class="string">&quot;()&quot;</span>))]</span><br><span class="line">       <span class="comment">-- Test name1</span></span><br><span class="line">       str1 = <span class="string">&quot;---\n S ::= a.\n _ ::= &#123;()&#125;.&quot;</span></span><br><span class="line">       eg2 = [((<span class="string">&quot;S&quot;</span>, <span class="type">RPlain</span>, <span class="type">Nothing</span>),</span><br><span class="line">              <span class="type">ESimple</span> (<span class="type">SNTerm</span> <span class="string">&quot;a&quot;</span>)),</span><br><span class="line">              ((<span class="string">&quot;_&quot;</span>, <span class="type">RSep</span>, <span class="type">Nothing</span>), <span class="type">ESeq</span> [] (<span class="string">&quot;()&quot;</span>))]</span><br><span class="line">       <span class="comment">-- Test name2</span></span><br><span class="line">       str2 = <span class="string">&quot;---\n S ::= asdf1234.\n _ ::= &#123;()&#125;.&quot;</span></span><br><span class="line">       eg3 = [((<span class="string">&quot;S&quot;</span>, <span class="type">RPlain</span>, <span class="type">Nothing</span>),</span><br><span class="line">              <span class="type">ESimple</span> (<span class="type">SNTerm</span> <span class="string">&quot;asdf1234&quot;</span>)),</span><br><span class="line">              ((<span class="string">&quot;_&quot;</span>, <span class="type">RSep</span>, <span class="type">Nothing</span>), <span class="type">ESeq</span> [] (<span class="string">&quot;()&quot;</span>))]</span><br><span class="line">       <span class="comment">-- Test name3</span></span><br><span class="line">       str3 = <span class="string">&quot;---\n S ::= a________1.\n _ ::= &#123;()&#125;.&quot;</span></span><br><span class="line">       eg4 = [((<span class="string">&quot;S&quot;</span>, <span class="type">RPlain</span>, <span class="type">Nothing</span>),</span><br><span class="line">              <span class="type">ESimple</span> (<span class="type">SNTerm</span> <span class="string">&quot;a________1&quot;</span>)),</span><br><span class="line">              ((<span class="string">&quot;_&quot;</span>, <span class="type">RSep</span>, <span class="type">Nothing</span>), <span class="type">ESeq</span> [] (<span class="string">&quot;()&quot;</span>))]</span><br><span class="line">       <span class="comment">-- Test name4</span></span><br><span class="line">       str4 = <span class="string">&quot;---\n S ::= 123.\n _ ::= &#123;()&#125;.&quot;</span></span><br><span class="line">       <span class="comment">-- Test Comment1</span></span><br><span class="line">       str5 = <span class="string">&quot;---\n S --ppp\n::= --ppp\nS \&quot;a\&quot; &#123;_1+1&#125; | \&quot;b\&quot; &#123;0&#125;.\n _ ::= &#123;()&#125;.&quot;</span></span><br><span class="line">       eg5 = [((<span class="string">&quot;S&quot;</span>, <span class="type">RPlain</span>, <span class="type">Nothing</span>),</span><br><span class="line">              <span class="type">EBar</span> (<span class="type">ESeq</span> [<span class="type">ESimple</span> (<span class="type">SNTerm</span> <span class="string">&quot;S&quot;</span>), <span class="type">ESimple</span> (<span class="type">SLit</span> <span class="string">&quot;a&quot;</span>)] <span class="string">&quot;_1+1&quot;</span>)</span><br><span class="line">                            (<span class="type">ESeq</span> [<span class="type">ESimple</span> (<span class="type">SLit</span> <span class="string">&quot;b&quot;</span>)] <span class="string">&quot;0&quot;</span>)),</span><br><span class="line">              ((<span class="string">&quot;_&quot;</span>, <span class="type">RSep</span>, <span class="type">Nothing</span>), <span class="type">ESeq</span> [] (<span class="string">&quot;()&quot;</span>))]</span><br><span class="line">       <span class="comment">-- Test Comment2</span></span><br><span class="line">       str6 = <span class="string">&quot;---\n S --ppp\n--ppp\n--ppp\n::= S \&quot;a\&quot; &#123;_1+1&#125; | \&quot;b\&quot; &#123;0&#125;.\n _ ::= &#123;()&#125;.&quot;</span></span><br><span class="line">       eg6 = [((<span class="string">&quot;S&quot;</span>, <span class="type">RPlain</span>, <span class="type">Nothing</span>),</span><br><span class="line">              <span class="type">EBar</span> (<span class="type">ESeq</span> [<span class="type">ESimple</span> (<span class="type">SNTerm</span> <span class="string">&quot;S&quot;</span>), <span class="type">ESimple</span> (<span class="type">SLit</span> <span class="string">&quot;a&quot;</span>)] <span class="string">&quot;_1+1&quot;</span>)</span><br><span class="line">                            (<span class="type">ESeq</span> [<span class="type">ESimple</span> (<span class="type">SLit</span> <span class="string">&quot;b&quot;</span>)] <span class="string">&quot;0&quot;</span>)),</span><br><span class="line">              ((<span class="string">&quot;_&quot;</span>, <span class="type">RSep</span>, <span class="type">Nothing</span>), <span class="type">ESeq</span> [] (<span class="string">&quot;()&quot;</span>))]</span><br><span class="line">       <span class="comment">-- Test Comment3</span></span><br><span class="line">       str7 = <span class="string">&quot;---\n S --ppp\n   --ppp\n   --ppp\n::= S \&quot;a\&quot; &#123;_1+1&#125; |  --aqqwe\n \&quot;b\&quot; &#123;0&#125;.\n _ ::= &#123;()&#125;.&quot;</span></span><br><span class="line">       eg7 = [((<span class="string">&quot;S&quot;</span>, <span class="type">RPlain</span>, <span class="type">Nothing</span>),</span><br><span class="line">              <span class="type">EBar</span> (<span class="type">ESeq</span> [<span class="type">ESimple</span> (<span class="type">SNTerm</span> <span class="string">&quot;S&quot;</span>), <span class="type">ESimple</span> (<span class="type">SLit</span> <span class="string">&quot;a&quot;</span>)] <span class="string">&quot;_1+1&quot;</span>)</span><br><span class="line">                            (<span class="type">ESeq</span> [<span class="type">ESimple</span> (<span class="type">SLit</span> <span class="string">&quot;b&quot;</span>)] <span class="string">&quot;0&quot;</span>)),</span><br><span class="line">              ((<span class="string">&quot;_&quot;</span>, <span class="type">RSep</span>, <span class="type">Nothing</span>), <span class="type">ESeq</span> [] (<span class="string">&quot;()&quot;</span>))]</span><br><span class="line">       <span class="comment">-- Test tokLit1</span></span><br><span class="line">       str8 = <span class="string">&quot;---\n S ::= \&quot;a\&quot;.\n _ ::= &#123;()&#125;.&quot;</span></span><br><span class="line">       eg8 = [((<span class="string">&quot;S&quot;</span>, <span class="type">RPlain</span>, <span class="type">Nothing</span>),</span><br><span class="line">              <span class="type">ESimple</span> (<span class="type">SLit</span> <span class="string">&quot;a&quot;</span>)),</span><br><span class="line">              ((<span class="string">&quot;_&quot;</span>, <span class="type">RSep</span>, <span class="type">Nothing</span>), <span class="type">ESeq</span> [] (<span class="string">&quot;()&quot;</span>))]</span><br><span class="line">       <span class="comment">-- Test tokLit2</span></span><br><span class="line">       str9 = <span class="string">&quot;---\n S ::= \&quot;aa\&quot;a\&quot;.\n _ ::= &#123;()&#125;.&quot;</span></span><br><span class="line">       eg9 = [((<span class="string">&quot;S&quot;</span>,<span class="type">RPlain</span>,<span class="type">Nothing</span>),<span class="type">ESimple</span> (<span class="type">SLit</span> <span class="string">&quot;aa\&quot;\&quot;a&quot;</span>)),((<span class="string">&quot;_&quot;</span>,<span class="type">RSep</span>,<span class="type">Nothing</span>),<span class="type">ESeq</span> [] <span class="string">&quot;()&quot;</span>)]</span><br><span class="line">       <span class="comment">-- Test tokLit3</span></span><br><span class="line">       str10 = <span class="string">&quot;---\n S ::= \&quot;a\&quot; \&quot;\&quot;\&quot;.\n _ ::= &#123;()&#125;.&quot;</span></span><br><span class="line">       <span class="comment">-- Test CharLit1</span></span><br><span class="line">       str11 = <span class="string">&quot;---\n S ::= \&#x27;a\&#x27;.\n _ ::= &#123;()&#125;.&quot;</span></span><br><span class="line">       eg11 = [((<span class="string">&quot;S&quot;</span>,<span class="type">RPlain</span>,<span class="type">Nothing</span>),<span class="type">ESimple</span> (<span class="type">SChar</span> &#x27;a&#x27;)),((<span class="string">&quot;_&quot;</span>,<span class="type">RSep</span>,<span class="type">Nothing</span>),<span class="type">ESeq</span> [] <span class="string">&quot;()&quot;</span>)]</span><br><span class="line">       <span class="comment">-- Test CharLit2</span></span><br><span class="line">       str12 = <span class="string">&quot;---\n S ::= \&#x27;a\&#x27; \&#x27;b\&#x27;.\n _ ::= &#123;()&#125;.&quot;</span></span><br><span class="line">       <span class="comment">-- Test CharLit3</span></span><br><span class="line">       str13 = <span class="string">&quot;---\n S ::= \&#x27;a\&#x27;\&#x27;.\n _ ::= &#123;()&#125;.&quot;</span></span><br><span class="line">       <span class="comment">-- Test Atom1</span></span><br><span class="line">       str14 = <span class="string">&quot;---\n S ::= a.\n _ ::= &#123;()&#125;.&quot;</span></span><br><span class="line">       eg14 = [((<span class="string">&quot;S&quot;</span>,<span class="type">RPlain</span>,<span class="type">Nothing</span>),<span class="type">ESimple</span> (<span class="type">SNTerm</span> <span class="string">&quot;a&quot;</span>)),((<span class="string">&quot;_&quot;</span>,<span class="type">RSep</span>,<span class="type">Nothing</span>),<span class="type">ESeq</span> [] <span class="string">&quot;()&quot;</span>)]</span><br><span class="line">       <span class="comment">-- Test Atom2</span></span><br><span class="line">       str15 = <span class="string">&quot;---\n S ::= @.\n _ ::= &#123;()&#125;.&quot;</span></span><br><span class="line">       eg15 = [((<span class="string">&quot;S&quot;</span>,<span class="type">RPlain</span>,<span class="type">Nothing</span>),<span class="type">ESimple</span> <span class="type">SAnyChar</span>),((<span class="string">&quot;_&quot;</span>,<span class="type">RSep</span>,<span class="type">Nothing</span>),<span class="type">ESeq</span> [] <span class="string">&quot;()&quot;</span>)]</span><br><span class="line">       <span class="comment">-- Test Atom3</span></span><br><span class="line">       str16 = <span class="string">&quot;---\n S ::= (a).\n _ ::= &#123;()&#125;.&quot;</span></span><br><span class="line">       eg16 = [((<span class="string">&quot;S&quot;</span>,<span class="type">RPlain</span>,<span class="type">Nothing</span>),<span class="type">ESimple</span> (<span class="type">SNTerm</span> <span class="string">&quot;a&quot;</span>)),((<span class="string">&quot;_&quot;</span>,<span class="type">RSep</span>,<span class="type">Nothing</span>),<span class="type">ESeq</span> [] <span class="string">&quot;()&quot;</span>)]</span><br><span class="line">       <span class="comment">-- Test Simple01</span></span><br><span class="line">       str17 = <span class="string">&quot;---\n S ::= a.\n _ ::= &#123;()&#125;.&quot;</span></span><br><span class="line">       eg17 = [((<span class="string">&quot;S&quot;</span>,<span class="type">RPlain</span>,<span class="type">Nothing</span>),<span class="type">ESimple</span> (<span class="type">SNTerm</span> <span class="string">&quot;a&quot;</span>)),((<span class="string">&quot;_&quot;</span>,<span class="type">RSep</span>,<span class="type">Nothing</span>),<span class="type">ESeq</span> [] <span class="string">&quot;()&quot;</span>)]</span><br><span class="line">       <span class="comment">-- Test Simple02</span></span><br><span class="line">       str18 = <span class="string">&quot;---\n S ::= @&#123;?aaa&#125;.\n _ ::= &#123;()&#125;.&quot;</span></span><br><span class="line">       eg18 = [((<span class="string">&quot;S&quot;</span>,<span class="type">RPlain</span>,<span class="type">Nothing</span>),<span class="type">EPred</span> (<span class="type">ESimple</span> <span class="type">SAnyChar</span>) <span class="string">&quot;aaa&quot;</span>),((<span class="string">&quot;_&quot;</span>,<span class="type">RSep</span>,<span class="type">Nothing</span>),<span class="type">ESeq</span> [] <span class="string">&quot;()&quot;</span>)]</span><br><span class="line">       <span class="comment">-- Test Simple03</span></span><br><span class="line">       str19 = <span class="string">&quot;---\n S ::= @&#123;? isNum &#125;.\n _ ::= &#123;()&#125;.&quot;</span></span><br><span class="line">       eg19 = [((<span class="string">&quot;S&quot;</span>,<span class="type">RPlain</span>,<span class="type">Nothing</span>),<span class="type">EPred</span> (<span class="type">ESimple</span> <span class="type">SAnyChar</span>) <span class="string">&quot; isNum &quot;</span>),((<span class="string">&quot;_&quot;</span>,<span class="type">RSep</span>,<span class="type">Nothing</span>),<span class="type">ESeq</span> [] <span class="string">&quot;()&quot;</span>)]</span><br><span class="line">       <span class="comment">-- Test Simple1</span></span><br><span class="line">       str20 = <span class="string">&quot;---\n S ::= a*.\n _ ::= &#123;()&#125;.&quot;</span></span><br><span class="line">       eg20 = [((<span class="string">&quot;S&quot;</span>,<span class="type">RPlain</span>,<span class="type">Nothing</span>),<span class="type">EMany</span> (<span class="type">ESimple</span> (<span class="type">SNTerm</span> <span class="string">&quot;a&quot;</span>))),((<span class="string">&quot;_&quot;</span>,<span class="type">RSep</span>,<span class="type">Nothing</span>),<span class="type">ESeq</span> [] <span class="string">&quot;()&quot;</span>)]</span><br><span class="line">       <span class="comment">-- Test Simple2</span></span><br><span class="line">       str21 = <span class="string">&quot;---\n S ::= a?.\n _ ::= &#123;()&#125;.&quot;</span></span><br><span class="line">       eg21 = [((<span class="string">&quot;S&quot;</span>,<span class="type">RPlain</span>,<span class="type">Nothing</span>),<span class="type">EOption</span> (<span class="type">ESimple</span> (<span class="type">SNTerm</span> <span class="string">&quot;a&quot;</span>))),((<span class="string">&quot;_&quot;</span>,<span class="type">RSep</span>,<span class="type">Nothing</span>),<span class="type">ESeq</span> [] <span class="string">&quot;()&quot;</span>)]</span><br><span class="line">       <span class="comment">-- Test Simple3</span></span><br><span class="line">       str22 = <span class="string">&quot;---\n S ::= !a.\n _ ::= &#123;()&#125;.&quot;</span></span><br><span class="line">       eg22 = [((<span class="string">&quot;S&quot;</span>,<span class="type">RPlain</span>,<span class="type">Nothing</span>),<span class="type">ENot</span> (<span class="type">ESimple</span> (<span class="type">SNTerm</span> <span class="string">&quot;a&quot;</span>))),((<span class="string">&quot;_&quot;</span>,<span class="type">RSep</span>,<span class="type">Nothing</span>),<span class="type">ESeq</span> [] <span class="string">&quot;()&quot;</span>)]</span><br><span class="line">       <span class="comment">-- Test htext1</span></span><br><span class="line">       str23 = <span class="string">&quot;---\n S ::= a &#123;_1+1&#125;.\n _ ::= &#123;()&#125;.&quot;</span></span><br><span class="line">       eg23 = [((<span class="string">&quot;S&quot;</span>,<span class="type">RPlain</span>,<span class="type">Nothing</span>),<span class="type">ESeq</span> [<span class="type">ESimple</span> (<span class="type">SNTerm</span> <span class="string">&quot;a&quot;</span>)] <span class="string">&quot;_1+1&quot;</span>),((<span class="string">&quot;_&quot;</span>,<span class="type">RSep</span>,<span class="type">Nothing</span>),<span class="type">ESeq</span> [] <span class="string">&quot;()&quot;</span>)]</span><br><span class="line">       <span class="comment">-- Test htext2</span></span><br><span class="line">       str24 = <span class="string">&quot;---\n S ::= a &#123;&#123;_1+1&#125;&#125;.\n _ ::= &#123;()&#125;.&quot;</span></span><br><span class="line">       eg24 = [((<span class="string">&quot;S&quot;</span>,<span class="type">RPlain</span>,<span class="type">Nothing</span>),<span class="type">ESeq</span> [<span class="type">ESimple</span> (<span class="type">SNTerm</span> <span class="string">&quot;a&quot;</span>)] <span class="string">&quot;&#123;_1+1&#125;&quot;</span>),((<span class="string">&quot;_&quot;</span>,<span class="type">RSep</span>,<span class="type">Nothing</span>),<span class="type">ESeq</span> [] <span class="string">&quot;()&quot;</span>)]</span><br><span class="line">       <span class="comment">-- Test htext3</span></span><br><span class="line">       str25 = <span class="string">&quot;---\n S ::= a &#123;:_1+1&#125; b.\n _ ::= &#123;()&#125;.&quot;</span></span><br><span class="line">       <span class="comment">-- Test htext4</span></span><br><span class="line">       str26 = <span class="string">&quot;---\n S ::= a &#123;?_1+1&#125;.\n _ ::= &#123;()&#125;.&quot;</span></span><br><span class="line">       <span class="comment">-- Test LHS1</span></span><br><span class="line">       str27 = <span class="string">&quot;---\n S &#123;:P&#125;::= a.\n _ ::= &#123;()&#125;.&quot;</span></span><br><span class="line">       eg27 = [((<span class="string">&quot;S&quot;</span>,<span class="type">RPlain</span>,<span class="type">Just</span> (<span class="type">AUser</span> <span class="string">&quot;P&quot;</span>)),<span class="type">ESimple</span> (<span class="type">SNTerm</span> <span class="string">&quot;a&quot;</span>)),((<span class="string">&quot;_&quot;</span>,<span class="type">RSep</span>,<span class="type">Nothing</span>),<span class="type">ESeq</span> [] <span class="string">&quot;()&quot;</span>)]</span><br><span class="line">       <span class="comment">-- Test LHS2</span></span><br><span class="line">       str28 = <span class="string">&quot;---\n s &#123;:P&#125; ::= a.\n _ ::= &#123;()&#125;.&quot;</span></span><br><span class="line">       eg28 = [((<span class="string">&quot;s&quot;</span>,<span class="type">RToken</span>,<span class="type">Just</span> (<span class="type">AUser</span> <span class="string">&quot;P&quot;</span>)),<span class="type">ESimple</span> (<span class="type">SNTerm</span> <span class="string">&quot;a&quot;</span>)),((<span class="string">&quot;_&quot;</span>,<span class="type">RSep</span>,<span class="type">Nothing</span>),<span class="type">ESeq</span> [] <span class="string">&quot;()&quot;</span>)]</span><br><span class="line">       <span class="comment">-- Test LHS3</span></span><br><span class="line">       str29 = <span class="string">&quot;---\n _ ::= &#123;()&#125;.&quot;</span></span><br><span class="line">       eg29 = [((<span class="string">&quot;_&quot;</span>,<span class="type">RSep</span>,<span class="type">Nothing</span>),<span class="type">ESeq</span> [] <span class="string">&quot;()&quot;</span>)]</span><br><span class="line">       <span class="comment">-- Test Preamble1</span></span><br><span class="line">       str30 = <span class="string">&quot;asdasdasd---\n S ::= a.\n _ ::= &#123;()&#125;.&quot;</span></span><br><span class="line">       eg30 = [((<span class="string">&quot;S&quot;</span>, <span class="type">RPlain</span>, <span class="type">Nothing</span>),</span><br><span class="line">              <span class="type">ESimple</span> (<span class="type">SNTerm</span> <span class="string">&quot;a&quot;</span>)),</span><br><span class="line">              ((<span class="string">&quot;_&quot;</span>, <span class="type">RSep</span>, <span class="type">Nothing</span>), <span class="type">ESeq</span> [] (<span class="string">&quot;()&quot;</span>))]</span><br><span class="line">       <span class="comment">-- Test Preamble2</span></span><br><span class="line">       str31 = <span class="string">&quot;a s d a s d a s d ---\n S ::= a.\n _ ::= &#123;()&#125;.&quot;</span></span><br><span class="line">       eg31 = [((<span class="string">&quot;S&quot;</span>, <span class="type">RPlain</span>, <span class="type">Nothing</span>),</span><br><span class="line">              <span class="type">ESimple</span> (<span class="type">SNTerm</span> <span class="string">&quot;a&quot;</span>)),</span><br><span class="line">              ((<span class="string">&quot;_&quot;</span>, <span class="type">RSep</span>, <span class="type">Nothing</span>), <span class="type">ESeq</span> [] (<span class="string">&quot;()&quot;</span>))]</span><br><span class="line">       <span class="comment">-- Test Preamble3</span></span><br><span class="line">       str32 = <span class="string">&quot;a s d a s d a s d ---\n --asas\n S ::= a.\n _ ::= &#123;()&#125;.&quot;</span></span><br><span class="line">       eg32 = [((<span class="string">&quot;S&quot;</span>, <span class="type">RPlain</span>, <span class="type">Nothing</span>),</span><br><span class="line">              <span class="type">ESimple</span> (<span class="type">SNTerm</span> <span class="string">&quot;a&quot;</span>)),</span><br><span class="line">              ((<span class="string">&quot;_&quot;</span>, <span class="type">RSep</span>, <span class="type">Nothing</span>), <span class="type">ESeq</span> [] (<span class="string">&quot;()&quot;</span>))]</span><br><span class="line">       <span class="comment">-- Test ERules1</span></span><br><span class="line">       str33 = <span class="string">&quot;---\n S ::= S \&quot;a\&quot; &#123;_1+1&#125; | \&quot;b\&quot; &#123;0&#125;.\n _ ::= &#123;()&#125;.&quot;</span></span><br><span class="line">       eg33 = [((<span class="string">&quot;S&quot;</span>, <span class="type">RPlain</span>, <span class="type">Nothing</span>),</span><br><span class="line">              <span class="type">EBar</span> (<span class="type">ESeq</span> [<span class="type">ESimple</span> (<span class="type">SNTerm</span> <span class="string">&quot;S&quot;</span>), <span class="type">ESimple</span> (<span class="type">SLit</span> <span class="string">&quot;a&quot;</span>)] <span class="string">&quot;_1+1&quot;</span>)</span><br><span class="line">                            (<span class="type">ESeq</span> [<span class="type">ESimple</span> (<span class="type">SLit</span> <span class="string">&quot;b&quot;</span>)] <span class="string">&quot;0&quot;</span>)),</span><br><span class="line">              ((<span class="string">&quot;_&quot;</span>, <span class="type">RSep</span>, <span class="type">Nothing</span>), <span class="type">ESeq</span> [] (<span class="string">&quot;()&quot;</span>))]</span><br><span class="line">       <span class="comment">-- Transformer</span></span><br><span class="line">       <span class="comment">-- eg = [((&quot;S&quot;, RPlain, Nothing),</span></span><br><span class="line">       <span class="comment">--        EBar (ESeq [ESimple (SNTerm &quot;S&quot;), ESimple (SLit &quot;a&quot;)] &quot;_1+1&quot;)</span></span><br><span class="line">       <span class="comment">--                      (ESeq [ESimple (SLit &quot;b&quot;)] &quot;0&quot;)),</span></span><br><span class="line">       <span class="comment">--        ((&quot;_&quot;, RSep, Nothing), ESeq [] (&quot;()&quot;))]</span></span><br><span class="line">       g = [((<span class="string">&quot;S&quot;</span>, <span class="type">RPlain</span>, <span class="type">Nothing</span>),</span><br><span class="line">          [([<span class="type">SNTerm</span> <span class="string">&quot;S&quot;</span>, <span class="type">SLit</span> <span class="string">&quot;a&quot;</span>], <span class="type">AUser</span> <span class="string">&quot;_1+1&quot;</span>),</span><br><span class="line">           ([<span class="type">SLit</span> <span class="string">&quot;b&quot;</span>], <span class="type">AUser</span> <span class="string">&quot;0&quot;</span>)]),</span><br><span class="line">         ((<span class="string">&quot;_&quot;</span>, <span class="type">RSep</span>, <span class="type">Nothing</span>), [([], <span class="type">AUser</span> <span class="string">&quot;()&quot;</span>)])]</span><br></pre></td></tr></table></figure>
<h2 id="erlst-erl"><a class="header-anchor" href="#erlst-erl">¶</a>erlst.erl</h2>
<figure class="highlight erlang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">-module</span><span class="params">(erlst)</span>.</span><br><span class="line"><span class="keyword">-behaviour</span><span class="params">(gen_server)</span>.</span><br><span class="line"><span class="comment">% You are allowed to split your Erlang code in as many files as you</span></span><br><span class="line"><span class="comment">% find appropriate.</span></span><br><span class="line"><span class="comment">% However, you MUST have a module (this file) called erlst.</span></span><br><span class="line"></span><br><span class="line"><span class="comment">% Export at least the API:</span></span><br><span class="line"><span class="keyword">-export</span><span class="params">([launch/<span class="number">0</span>,</span></span><br><span class="line"><span class="params">         shutdown/<span class="number">1</span>,</span></span><br><span class="line"><span class="params">         open_account/<span class="number">2</span>,</span></span><br><span class="line"><span class="params">         account_balance/<span class="number">1</span>,</span></span><br><span class="line"><span class="params">         make_offer/<span class="number">2</span>,</span></span><br><span class="line"><span class="params">         rescind_offer/<span class="number">2</span>,</span></span><br><span class="line"><span class="params">         add_trader/<span class="number">2</span>,</span></span><br><span class="line"><span class="params">         remove_trader/<span class="number">2</span>,</span></span><br><span class="line"><span class="params">         show/<span class="number">1</span></span></span><br><span class="line"><span class="params">        ])</span>.</span><br><span class="line"></span><br><span class="line"><span class="comment">% You may have other exports as well</span></span><br><span class="line"><span class="keyword">-export</span><span class="params">([init/<span class="number">1</span>,terminate/<span class="number">2</span>,handle_call/<span class="number">3</span>,handle_cast/<span class="number">2</span>])</span>.</span><br><span class="line"><span class="keyword">-export</span><span class="params">([removeoffer/<span class="number">3</span>,run_strategy/<span class="number">2</span>,check_offer_exists/<span class="number">1</span>,run_all_traders/<span class="number">2</span>,run_all_Map_Res/<span class="number">4</span></span></span><br><span class="line"><span class="params">    ,transfer_stock/<span class="number">2</span>,change_stock/<span class="number">4</span>])</span>.</span><br><span class="line"></span><br><span class="line">-type stock_exchange<span class="params">()</span> :: term<span class="params">()</span>.</span><br><span class="line">-type account_id<span class="params">()</span> :: term<span class="params">()</span>.</span><br><span class="line">-type offer_id<span class="params">()</span> :: term<span class="params">()</span>.</span><br><span class="line">-type trader_id<span class="params">()</span> :: term<span class="params">()</span>.</span><br><span class="line">-type stock<span class="params">()</span> :: atom<span class="params">()</span>.</span><br><span class="line">-type isk<span class="params">()</span> :: non_neg_integer<span class="params">()</span>.</span><br><span class="line">-type stock_amount<span class="params">()</span> :: pos_integer<span class="params">()</span>.</span><br><span class="line">-type holdings<span class="params">()</span> :: &#123;isk<span class="params">()</span>, [&#123;stock<span class="params">()</span>, stock_amount<span class="params">()</span>&#125;]&#125;.</span><br><span class="line">-type offer<span class="params">()</span> :: &#123;stock<span class="params">()</span>, isk<span class="params">()</span>&#125;.</span><br><span class="line">-type decision<span class="params">()</span> :: accept | reject.</span><br><span class="line">-type trader_strategy<span class="params">()</span> :: fun<span class="params">((offer())</span> -&gt; decision<span class="params">()</span>).</span><br><span class="line"></span><br><span class="line"><span class="comment">% --------------------------user API----------------</span></span><br><span class="line"><span class="keyword">-spec</span> launch<span class="params">()</span> -&gt; &#123;ok, stock_exchange<span class="params">()</span>&#125; | &#123;error, term<span class="params">()</span>&#125;.</span><br><span class="line"><span class="function"><span class="title">launch</span><span class="params">()</span> -&gt;</span></span><br><span class="line">    gen_server:start_link(?MODULE, [], []).</span><br><span class="line"></span><br><span class="line"><span class="keyword">-spec</span> shutdown<span class="params">(S :: stock_exchange())</span> -&gt; non_neg_integer<span class="params">()</span>.</span><br><span class="line"><span class="function"><span class="title">shutdown</span><span class="params">(S)</span> -&gt;</span></span><br><span class="line">    Ret = gen_server:call(S, shutdown),</span><br><span class="line">    Ret.</span><br><span class="line"></span><br><span class="line"><span class="keyword">-spec</span> open_account<span class="params">(S :: stock_exchange(), holdings())</span> -&gt; account_id<span class="params">()</span>.</span><br><span class="line"><span class="function"><span class="title">open_account</span><span class="params">(S,Holdings)</span> -&gt;</span></span><br><span class="line">    gen_server:call(S, &#123;open_account, Holdings,S&#125;).</span><br><span class="line"></span><br><span class="line"><span class="keyword">-spec</span> account_balance<span class="params">(Acct :: account_id())</span> -&gt; holdings<span class="params">()</span>.</span><br><span class="line"><span class="function"><span class="title">account_balance</span><span class="params">(Acct)</span> -&gt;</span></span><br><span class="line">    <span class="keyword">case</span> Acct <span class="keyword">of</span></span><br><span class="line">        &#123;Server,Id&#125; -&gt;</span><br><span class="line">            gen_server:call(Server, &#123;account_balance, Id&#125;);</span><br><span class="line">        _ -&gt;</span><br><span class="line">            &#123;error, badAcct&#125;</span><br><span class="line">    <span class="keyword">end</span>.</span><br><span class="line"></span><br><span class="line"><span class="keyword">-spec</span> make_offer<span class="params">(Acct :: account_id(), Terms :: offer())</span> -&gt; &#123;ok, offer_id<span class="params">()</span>&#125; | &#123;error, term<span class="params">()</span>&#125;.</span><br><span class="line"><span class="function"><span class="title">make_offer</span><span class="params">(Acct, Offer)</span> -&gt;</span></span><br><span class="line">    <span class="keyword">case</span> check_Account_exist(Acct) <span class="keyword">of</span></span><br><span class="line">        <span class="literal">true</span> -&gt;</span><br><span class="line">            <span class="keyword">case</span> Acct <span class="keyword">of</span></span><br><span class="line">                &#123;Server,Id&#125; -&gt;</span><br><span class="line">                    gen_server:call(Server, &#123;make_offer, Offer, Id&#125;);</span><br><span class="line">                _ -&gt;</span><br><span class="line">                    &#123;error, badAcct&#125;</span><br><span class="line">            <span class="keyword">end</span>;</span><br><span class="line">        <span class="literal">false</span> -&gt;</span><br><span class="line">            &#123;error, notexist&#125;</span><br><span class="line">    <span class="keyword">end</span>.</span><br><span class="line"></span><br><span class="line"><span class="keyword">-spec</span> rescind_offer<span class="params">(Acct :: account_id(), Offer :: offer_id())</span> -&gt; ok.</span><br><span class="line"><span class="function"><span class="title">rescind_offer</span><span class="params">(Acct, Offer)</span> -&gt;</span></span><br><span class="line">    <span class="keyword">case</span> check_Account_exist(Acct) <span class="keyword">of</span></span><br><span class="line">        <span class="literal">true</span> -&gt;</span><br><span class="line">            <span class="keyword">case</span> Acct <span class="keyword">of</span></span><br><span class="line">                &#123;Server,Id&#125; -&gt;</span><br><span class="line">                    gen_server:cast(Server, &#123;rescind_offer, Offer, Id&#125;);</span><br><span class="line">                _ -&gt;</span><br><span class="line">                    &#123;error, badAcct&#125;</span><br><span class="line">            <span class="keyword">end</span>;</span><br><span class="line">        <span class="literal">false</span> -&gt;</span><br><span class="line">            &#123;error, notexist&#125;</span><br><span class="line">    <span class="keyword">end</span>.</span><br><span class="line"></span><br><span class="line"><span class="keyword">-spec</span> add_trader<span class="params">(Acct :: account_id(), Strategy :: trader_strategy())</span> -&gt; trader_id<span class="params">()</span>.</span><br><span class="line"><span class="function"><span class="title">add_trader</span><span class="params">(Acct, Strategy)</span> -&gt;</span></span><br><span class="line">    <span class="keyword">case</span> check_Account_exist(Acct) <span class="keyword">of</span></span><br><span class="line">        <span class="literal">true</span> -&gt;</span><br><span class="line">            <span class="keyword">case</span> Acct <span class="keyword">of</span></span><br><span class="line">                &#123;Server,Id&#125; -&gt;</span><br><span class="line">                    gen_server:call(Server, &#123;add_trader, Strategy, Id&#125;);</span><br><span class="line">                _ -&gt;</span><br><span class="line">                    &#123;error, badAcct&#125;</span><br><span class="line">            <span class="keyword">end</span>;</span><br><span class="line">        <span class="literal">false</span> -&gt;</span><br><span class="line">            &#123;error, notexist&#125;</span><br><span class="line">    <span class="keyword">end</span>.</span><br><span class="line">    </span><br><span class="line"></span><br><span class="line"><span class="keyword">-spec</span> remove_trader<span class="params">(Acct :: account_id(), Trader :: trader_id())</span> -&gt; ok.</span><br><span class="line"><span class="function"><span class="title">remove_trader</span><span class="params">(Acct, Trader)</span> -&gt;</span></span><br><span class="line">    <span class="keyword">case</span> check_Account_exist(Acct) <span class="keyword">of</span></span><br><span class="line">        <span class="literal">true</span> -&gt;</span><br><span class="line">            <span class="keyword">case</span> Acct <span class="keyword">of</span></span><br><span class="line">                &#123;Server,Id&#125; -&gt;</span><br><span class="line">                    gen_server:cast(Server, &#123;remove_trader, Trader, Id&#125;);</span><br><span class="line">                _ -&gt;</span><br><span class="line">                    &#123;error, badAcct&#125;</span><br><span class="line">            <span class="keyword">end</span>;</span><br><span class="line">        <span class="literal">false</span> -&gt;</span><br><span class="line">            &#123;error, notexist&#125;</span><br><span class="line">    <span class="keyword">end</span>.</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">show</span><span class="params">(S)</span> -&gt;</span></span><br><span class="line">    gen_server:call(S, show).</span><br><span class="line"></span><br><span class="line"><span class="comment">% --------------------------server API----------------</span></span><br><span class="line"><span class="comment">% State is [Num,Accounts, Offers, Traders]</span></span><br><span class="line"><span class="comment">% Num is the number of trades</span></span><br><span class="line"><span class="comment">% Accounts is [&#123;&#123;S,Id&#125;,&#123;isk,[&#123;stock,amount&#125;.....]&#125;&#125;....]</span></span><br><span class="line"><span class="comment">% Offers is [&#123;OfferId,AccountId,&#123;stock,isk&#125;&#125;....]</span></span><br><span class="line"><span class="comment">% Traders is [&#123;TraderId,AccountId,Strategy&#125;....]</span></span><br><span class="line"><span class="comment">% Strategy = fun((Offer) -&gt; Decision), i.e. fun(&#123;&quot;Erlang Inc&quot;, Price&#125;) when Price =&lt; 42 -&gt; accept; (_) -&gt; reject end.</span></span><br><span class="line"><span class="function"><span class="title">init</span><span class="params">([])</span> -&gt;</span></span><br><span class="line">    &#123;ok, [<span class="number">0</span>,[],[],[]]&#125;.</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">handle_call</span><span class="params">(&#123;open_account, Holdings,Server&#125;, _From, [Num, Accounts, Offers, Traders])</span> -&gt;</span></span><br><span class="line">    &#123;H,M,S&#125; = erlang:now(),</span><br><span class="line">    AccountId = lists:concat([&#x27;A&#x27;,H,M,S]),</span><br><span class="line">    <span class="keyword">case</span> checkHoldings(Holdings) <span class="keyword">of</span> </span><br><span class="line">        <span class="literal">true</span> -&gt;</span><br><span class="line">            &#123;reply, &#123;Server,AccountId&#125;, [Num, [&#123;&#123;Server,AccountId&#125;,Holdings&#125;|Accounts], Offers, Traders]&#125;;</span><br><span class="line">        <span class="literal">false</span> -&gt;</span><br><span class="line">            &#123;reply, &#123;error, badHoldings&#125;, [Num, Accounts, Offers, Traders]&#125;</span><br><span class="line">    <span class="keyword">end</span>;</span><br><span class="line"><span class="function"><span class="title">handle_call</span><span class="params">(show, _From, [Num, Accounts, Offers, Traders])</span> -&gt;</span></span><br><span class="line">    io:format(<span class="string">&quot;Num: ~p~n&quot;</span>,[Num]),</span><br><span class="line">    io:format(<span class="string">&quot;Accounts: ~p~n&quot;</span>,[Accounts]),</span><br><span class="line">    io:format(<span class="string">&quot;Offers: ~p~n&quot;</span>,[Offers]),</span><br><span class="line">    io:format(<span class="string">&quot;Traders: ~p~n&quot;</span>,[Traders]),</span><br><span class="line">    &#123;reply,&#123;Accounts,Offers,Traders&#125;, [Num, Accounts, Offers, Traders]&#125;;</span><br><span class="line"><span class="function"><span class="title">handle_call</span><span class="params">(&#123;make_offer,Offer,Id&#125;, _From, [Num, Accounts, Offers, Traders])</span> -&gt;</span></span><br><span class="line">    <span class="keyword">case</span> Offer <span class="keyword">of</span></span><br><span class="line">        &#123;_, Price&#125; -&gt;</span><br><span class="line">            <span class="keyword">if</span> Price &gt;= <span class="number">0</span> -&gt;</span><br><span class="line">                &#123;H,M,S&#125; = erlang:now(),</span><br><span class="line">                OfferId = lists:concat([&#x27;O&#x27;,H,M,S]),</span><br><span class="line">                NewOffers = [&#123;OfferId,Id,Offer&#125;|Offers],</span><br><span class="line"></span><br><span class="line">                <span class="comment">% Run Traders</span></span><br><span class="line">                Map_Reses = run_all_traders(NewOffers, Traders),</span><br><span class="line">                &#123;NewAccounts, NewOffers1,NewNum&#125; = run_all_Map_Res(Map_Reses, Accounts, NewOffers,Num),</span><br><span class="line">                &#123;reply, &#123;ok, OfferId&#125;, [NewNum, NewAccounts, NewOffers1, Traders]&#125;;</span><br><span class="line">            <span class="literal">true</span> -&gt;</span><br><span class="line">                &#123;reply, &#123;error, badPrice&#125;, [Num, Accounts, Offers, Traders]&#125;</span><br><span class="line">            <span class="keyword">end</span>;</span><br><span class="line">        _ -&gt;</span><br><span class="line">            &#123;reply, &#123;error, badOffer&#125;, [Num, Accounts, Offers, Traders]&#125;</span><br><span class="line">    <span class="keyword">end</span>;</span><br><span class="line"><span class="function"><span class="title">handle_call</span><span class="params">(&#123;add_trader,Strategy,Id&#125;, _From, [Num, Accounts, Offers, Traders])</span> -&gt;</span></span><br><span class="line">    &#123;H,M,S&#125; = erlang:now(),</span><br><span class="line">    TraderId = lists:concat([&#x27;T&#x27;,H,M,S]),</span><br><span class="line">    NewTraders = [&#123;TraderId, Id, Strategy&#125;|Traders],</span><br><span class="line"></span><br><span class="line">    <span class="comment">% Run Traders</span></span><br><span class="line">    Map_Reses = run_all_traders(Offers, NewTraders),</span><br><span class="line">    &#123;NewAccounts, NewOffers,NewNum&#125; = run_all_Map_Res(Map_Reses, Accounts, Offers,Num),</span><br><span class="line">    &#123;reply, TraderId, [NewNum, NewAccounts, NewOffers, NewTraders]&#125;;</span><br><span class="line"><span class="function"><span class="title">handle_call</span><span class="params">(shutdown, _From, [Num, Accounts, Offers, Traders])</span> -&gt;</span></span><br><span class="line">    &#123;stop, normal, Num, [Num, Accounts, Offers, Traders]&#125;;</span><br><span class="line"><span class="function"><span class="title">handle_call</span><span class="params">(&#123;account_balance,Id&#125;, _From, [Num, Accounts, Offers, Traders])</span> -&gt;</span></span><br><span class="line">    Balance = getBalance(Id, Accounts),</span><br><span class="line">    &#123;reply, Balance, [Num, Accounts, Offers, Traders]&#125;.</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">handle_cast</span><span class="params">(&#123;rescind_offer,OfferId,Id&#125;, [Num, Accounts, Offers, Traders])</span> -&gt;</span></span><br><span class="line">    NewOffers = removeoffer(OfferId, Id, Offers),</span><br><span class="line">    &#123;noreply,[Num, Accounts, NewOffers, Traders]&#125;;</span><br><span class="line"><span class="function"><span class="title">handle_cast</span><span class="params">(&#123;remove_trader,TraderId,Id&#125;, [Num, Accounts, Offers, Traders])</span> -&gt;</span></span><br><span class="line">    NewTraders = removetrader(TraderId, Id, Traders),</span><br><span class="line">    &#123;noreply,[Num, Accounts, Offers, NewTraders]&#125;</span><br><span class="line">.</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">terminate</span><span class="params">(_Reason, _State)</span> -&gt;</span></span><br><span class="line">    ok.</span><br><span class="line"></span><br><span class="line"><span class="comment">% --------------------------helper functions----------------------------</span></span><br><span class="line"><span class="function"><span class="title">checkHoldings</span><span class="params">(Holdings)</span> -&gt;</span></span><br><span class="line">    <span class="keyword">case</span> Holdings <span class="keyword">of</span></span><br><span class="line">        &#123;ISK, STOCKS&#125; -&gt;</span><br><span class="line">            <span class="keyword">if</span> ISK &gt;= <span class="number">0</span> -&gt;</span><br><span class="line">                checkStocks(STOCKS);</span><br><span class="line">            <span class="literal">true</span> -&gt;</span><br><span class="line">                <span class="literal">false</span></span><br><span class="line">            <span class="keyword">end</span>;</span><br><span class="line">        _ -&gt;</span><br><span class="line">            <span class="literal">false</span></span><br><span class="line">    <span class="keyword">end</span>.</span><br><span class="line"></span><br><span class="line"><span class="comment">% adasd</span></span><br><span class="line"><span class="function"><span class="title">checkStocks</span><span class="params">(STOCKS)</span> -&gt;</span></span><br><span class="line">    <span class="keyword">case</span> STOCKS <span class="keyword">of</span></span><br><span class="line">        [] -&gt;</span><br><span class="line">            <span class="literal">true</span>;</span><br><span class="line">        &#123;_, Amount&#125; -&gt;</span><br><span class="line">            <span class="keyword">if</span> Amount &gt;= <span class="number">0</span> -&gt;</span><br><span class="line">                <span class="literal">true</span>;</span><br><span class="line">            <span class="literal">true</span> -&gt;</span><br><span class="line">                <span class="literal">false</span></span><br><span class="line">            <span class="keyword">end</span>;</span><br><span class="line">        [&#123;_,Amount&#125;|STOCKS1] -&gt;</span><br><span class="line">            <span class="keyword">if</span> Amount &gt;= <span class="number">0</span> -&gt;</span><br><span class="line">                checkStocks(STOCKS1);</span><br><span class="line">            <span class="literal">true</span> -&gt;</span><br><span class="line">                <span class="literal">false</span></span><br><span class="line">            <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span>.</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">getBalance</span><span class="params">(Id, Accounts)</span> -&gt;</span></span><br><span class="line">    <span class="keyword">case</span> Accounts <span class="keyword">of</span></span><br><span class="line">        [] -&gt;</span><br><span class="line">            &#123;error, empty&#125;;</span><br><span class="line">        [&#123;&#123;_,Id&#125;,&#123;Balance,Share&#125;&#125;|_] -&gt;</span><br><span class="line">            &#123;Balance,Share&#125;;</span><br><span class="line">        [_|T] -&gt;</span><br><span class="line">            getBalance(Id, T)</span><br><span class="line">    <span class="keyword">end</span>.</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">removeoffer</span><span class="params">(OfferId, Id, Offers)</span> -&gt;</span></span><br><span class="line">    <span class="keyword">case</span> Offers <span class="keyword">of</span></span><br><span class="line">        [] -&gt;</span><br><span class="line">            [];</span><br><span class="line">        [&#123;OfferId, Id, A&#125;|_] -&gt;</span><br><span class="line">            Offers -- [&#123;OfferId, Id, A&#125;];</span><br><span class="line">        [_|T] -&gt;</span><br><span class="line">            removeoffer(OfferId, Id, T)</span><br><span class="line">    <span class="keyword">end</span>.</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">removetrader</span><span class="params">(TraderId, Id, Traders)</span> -&gt;</span></span><br><span class="line">    <span class="keyword">case</span> Traders <span class="keyword">of</span></span><br><span class="line">        [] -&gt;</span><br><span class="line">            [];</span><br><span class="line">        [&#123;TraderId, Id, A&#125;|_] -&gt;</span><br><span class="line">            Traders -- [&#123;TraderId, Id, A&#125;];</span><br><span class="line">        [_|T] -&gt;</span><br><span class="line">            removetrader(TraderId, Id, T)</span><br><span class="line">    <span class="keyword">end</span>.</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">check_Account_exist</span><span class="params">(Id)</span> -&gt;</span></span><br><span class="line">    Balance = account_balance(Id),</span><br><span class="line">    <span class="keyword">case</span> Balance <span class="keyword">of</span></span><br><span class="line">        &#123;error, empty&#125; -&gt;</span><br><span class="line">            <span class="literal">false</span>;</span><br><span class="line">        _ -&gt;</span><br><span class="line">            <span class="literal">true</span></span><br><span class="line">    <span class="keyword">end</span>.</span><br><span class="line"></span><br><span class="line"><span class="comment">% -----------------------------Trader helper functions--------------------------------</span></span><br><span class="line"><span class="comment">% condition1</span></span><br><span class="line"><span class="function"><span class="title">check_offer_exists</span><span class="params">(Offers)</span> -&gt;</span></span><br><span class="line">    <span class="keyword">case</span> Offers <span class="keyword">of</span></span><br><span class="line">        [] -&gt;</span><br><span class="line">            <span class="literal">false</span>;</span><br><span class="line">        _ -&gt;</span><br><span class="line">            <span class="literal">true</span></span><br><span class="line">    <span class="keyword">end</span>.</span><br><span class="line"></span><br><span class="line"><span class="comment">% Use Strategy handle one offer</span></span><br><span class="line"><span class="function"><span class="title">run_strategy</span><span class="params">(Strategy, Offer)</span> -&gt;</span></span><br><span class="line">    Me = self(),</span><br><span class="line">    spawn(<span class="keyword">fun</span>() -&gt;</span><br><span class="line">        <span class="keyword">case</span> Strategy(Offer) <span class="keyword">of</span></span><br><span class="line">            accept -&gt;</span><br><span class="line">                Me ! accept;</span><br><span class="line">            reject -&gt;</span><br><span class="line">                Me ! reject;</span><br><span class="line">            _ -&gt;</span><br><span class="line">                Me ! reject</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span>),</span><br><span class="line">    <span class="keyword">receive</span></span><br><span class="line">        accept -&gt;</span><br><span class="line">            accept;</span><br><span class="line">        reject -&gt;</span><br><span class="line">            reject</span><br><span class="line">    <span class="keyword">end</span>.</span><br><span class="line"></span><br><span class="line"><span class="comment">% One trider run all offer</span></span><br><span class="line"><span class="function"><span class="title">map_offer</span><span class="params">(Offers, Trader)</span> -&gt;</span></span><br><span class="line">    &#123;_, Buyer, Strategy&#125; = Trader,</span><br><span class="line">    <span class="keyword">case</span> check_offer_exists(Offers) <span class="keyword">of</span></span><br><span class="line">        <span class="literal">true</span> -&gt;</span><br><span class="line">            lists:map(<span class="keyword">fun</span>(Offer) -&gt;</span><br><span class="line">                &#123;_,_,Temp&#125; = Offer,</span><br><span class="line">                Res = run_strategy(Strategy,Temp),</span><br><span class="line">                &#123;Res,Buyer,Offer&#125;</span><br><span class="line">            <span class="keyword">end</span>, Offers);</span><br><span class="line">        <span class="literal">false</span> -&gt;</span><br><span class="line">            []</span><br><span class="line">    <span class="keyword">end</span>.</span><br><span class="line"></span><br><span class="line"><span class="comment">% get all trader result</span></span><br><span class="line"><span class="function"><span class="title">run_all_traders</span><span class="params">(Offers, Traders)</span> -&gt;</span></span><br><span class="line">    lists:map(<span class="keyword">fun</span>(Trader) -&gt;</span><br><span class="line">        map_offer(Offers, Trader)</span><br><span class="line">    <span class="keyword">end</span>, Traders).</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">% get new Offers</span></span><br><span class="line"><span class="function"><span class="title">remove_offer</span><span class="params">(Map_Res,Offers)</span> -&gt;</span></span><br><span class="line">    <span class="keyword">case</span> Map_Res <span class="keyword">of</span></span><br><span class="line">        [] -&gt;</span><br><span class="line">            Offers;</span><br><span class="line">        [Res|T] -&gt;</span><br><span class="line">            <span class="keyword">case</span> Res <span class="keyword">of</span></span><br><span class="line">                &#123;accept,_,&#123;OfferId,Id,_&#125;&#125; -&gt;</span><br><span class="line">                    removeoffer(OfferId,Id,Offers);</span><br><span class="line">                _ -&gt;</span><br><span class="line">                    remove_offer(T,Offers)</span><br><span class="line">            <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span>.</span><br><span class="line"></span><br><span class="line"><span class="comment">% get new Map_Res and Accounts,return is &#123;Map_Res,Accounts&#125;</span></span><br><span class="line"><span class="function"><span class="title">transfer_stock</span><span class="params">(Map_Res, Accounts)</span> -&gt;</span></span><br><span class="line">    transfer_stock(Map_Res, Accounts, []).</span><br><span class="line"><span class="function"><span class="title">transfer_stock</span><span class="params">([], Accounts, NewMap_Res)</span> -&gt;</span></span><br><span class="line">    &#123;NewMap_Res, Accounts&#125;;</span><br><span class="line"><span class="function"><span class="title">transfer_stock</span><span class="params">(Map_Res, Accounts, NewMap_Res)</span> -&gt;</span></span><br><span class="line">    <span class="keyword">case</span> Map_Res <span class="keyword">of</span></span><br><span class="line">        [&#123;accept,Buyer,&#123;OfferId,Seller,&#123;Stock,Price&#125;&#125;&#125;|T] -&gt;</span><br><span class="line">            Acc1 = change_ISK(add, Seller, Price, Accounts),</span><br><span class="line">            <span class="keyword">case</span> change_ISK(remove, Buyer, Price, Acc1) <span class="keyword">of</span></span><br><span class="line">                &#123;error,not_enough_ISK&#125; -&gt;</span><br><span class="line">                    NewRes = &#123;reject,Buyer,&#123;OfferId,Seller,&#123;Stock,Price&#125;&#125;&#125;,</span><br><span class="line">                    transfer_stock(T, Accounts, [NewRes|NewMap_Res]);</span><br><span class="line">                Acc2 -&gt;</span><br><span class="line">                    Acc3 = change_stock(add, Buyer, Stock, Acc2),</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">case</span> change_stock(remove, Seller, Stock, Acc3) <span class="keyword">of</span></span><br><span class="line">                        &#123;error, aaa&#125; -&gt;</span><br><span class="line">                            NewRes = &#123;reject,Buyer,&#123;OfferId,Seller,&#123;Stock,Price&#125;&#125;&#125;,</span><br><span class="line">                            transfer_stock(T, Accounts,[NewRes|NewMap_Res]);</span><br><span class="line">                        Acc4 -&gt;</span><br><span class="line">                            NewRes = &#123;accept,Buyer,&#123;OfferId,Seller,&#123;Stock,Price&#125;&#125;&#125;,</span><br><span class="line">                            transfer_stock(T, Acc4, [NewRes|NewMap_Res])</span><br><span class="line">                    <span class="keyword">end</span></span><br><span class="line">            <span class="keyword">end</span>;</span><br><span class="line">        [&#123;reject,B,O&#125;|T] -&gt;</span><br><span class="line">            NewRes = &#123;reject,B,O&#125;,</span><br><span class="line">            transfer_stock(T, Accounts, [NewRes|NewMap_Res])</span><br><span class="line">    <span class="keyword">end</span>.</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">change_ISK</span><span class="params">(Label, Id, Price, Accounts)</span> -&gt;</span></span><br><span class="line">    <span class="keyword">case</span> Accounts <span class="keyword">of</span></span><br><span class="line">        [] -&gt;</span><br><span class="line">            [];</span><br><span class="line">        [&#123;&#123;S,Id&#125;, &#123;ISK, Holdings&#125;&#125;|T] -&gt;</span><br><span class="line">            <span class="keyword">case</span> Label <span class="keyword">of</span></span><br><span class="line">                add -&gt;</span><br><span class="line">                    [&#123;&#123;S,Id&#125;, &#123;ISK+Price, Holdings&#125;&#125;|T];</span><br><span class="line">                remove -&gt;</span><br><span class="line">                    <span class="keyword">case</span> ISK-Price &lt; <span class="number">0</span> <span class="keyword">of</span></span><br><span class="line">                        <span class="literal">true</span> -&gt;</span><br><span class="line">                            &#123;error, not_enough_ISK&#125;;</span><br><span class="line">                        <span class="literal">false</span> -&gt;</span><br><span class="line">                            [&#123;&#123;S,Id&#125;, &#123;ISK-Price, Holdings&#125;&#125;|T]</span><br><span class="line">                    <span class="keyword">end</span></span><br><span class="line">            <span class="keyword">end</span>;</span><br><span class="line">        [H|T] -&gt;</span><br><span class="line">            [H|change_ISK(Label, Id, Price, T)]</span><br><span class="line">    <span class="keyword">end</span>.</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">change_stock</span><span class="params">(_, _, _, [])</span> -&gt;</span></span><br><span class="line">    [];</span><br><span class="line"><span class="comment">% qwqw</span></span><br><span class="line"><span class="function"><span class="title">change_stock</span><span class="params">(_,_,_,&#123;error,_&#125;)</span>-&gt;</span></span><br><span class="line">    [];</span><br><span class="line"><span class="function"><span class="title">change_stock</span><span class="params">(Label, Id, Stock, [&#123;&#123;S,Id&#125;, &#123;ISK, Holdings&#125;&#125;|T])</span> -&gt;</span></span><br><span class="line">    <span class="keyword">case</span> Label <span class="keyword">of</span></span><br><span class="line">        add -&gt;</span><br><span class="line">            NewHoldings = add_stock(Stock, Holdings),</span><br><span class="line">            [&#123;&#123;S,Id&#125;, &#123;ISK, NewHoldings&#125;&#125;|T];</span><br><span class="line">        remove -&gt;</span><br><span class="line">            <span class="keyword">case</span> remove_stock(Stock, Holdings) <span class="keyword">of</span></span><br><span class="line">                &#123;error, not_enough_stock&#125; -&gt;</span><br><span class="line">                    &#123;error, aaa&#125;;</span><br><span class="line">                NewHoldings -&gt;</span><br><span class="line">                    [&#123;&#123;S,Id&#125;, &#123;ISK,NewHoldings&#125;&#125;|T]</span><br><span class="line">            <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span>;</span><br><span class="line"><span class="function"><span class="title">change_stock</span><span class="params">(Label, Id, Stock, [H|T])</span> -&gt;</span></span><br><span class="line">    <span class="keyword">case</span> change_stock(Label, Id, Stock, T) <span class="keyword">of</span></span><br><span class="line">        &#123;error, aaa&#125; -&gt;</span><br><span class="line">            &#123;error, aaa&#125;;</span><br><span class="line">        NewT -&gt;</span><br><span class="line">            [H|NewT]</span><br><span class="line">    <span class="keyword">end</span>.</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">remove_stock</span><span class="params">(Stock, Holdings)</span> -&gt;</span></span><br><span class="line">    <span class="keyword">case</span> Holdings <span class="keyword">of</span></span><br><span class="line">        [] -&gt;</span><br><span class="line">            &#123;error, not_enough_stock&#125;;</span><br><span class="line">        [H|T] -&gt;</span><br><span class="line">            <span class="keyword">case</span> H <span class="keyword">of</span></span><br><span class="line">                &#123;Stock, Amount&#125; -&gt;</span><br><span class="line">                    <span class="keyword">case</span> Amount <span class="keyword">of</span></span><br><span class="line">                        <span class="number">1</span> -&gt;</span><br><span class="line">                            T;</span><br><span class="line">                        _ -&gt;</span><br><span class="line">                            [&#123;Stock, Amount-<span class="number">1</span>&#125;|T]</span><br><span class="line">                    <span class="keyword">end</span>;</span><br><span class="line">                _ -&gt;</span><br><span class="line">                    [H|remove_stock(Stock, T)]</span><br><span class="line">            <span class="keyword">end</span>;</span><br><span class="line">        _ -&gt;</span><br><span class="line">            &#123;error, not_enough_stock&#125;</span><br><span class="line">    <span class="keyword">end</span>.</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">add_stock</span><span class="params">(Stock, Holdings)</span> -&gt;</span></span><br><span class="line">    <span class="keyword">case</span> Holdings <span class="keyword">of</span></span><br><span class="line">        [] -&gt;</span><br><span class="line">            [&#123;Stock,<span class="number">1</span>&#125;];</span><br><span class="line">        &#123;Stock, Amount&#125; -&gt;</span><br><span class="line">            &#123;Stock, Amount+<span class="number">1</span>&#125;;</span><br><span class="line">        &#123;_, _&#125; -&gt;</span><br><span class="line">            [&#123;Stock,<span class="number">1</span>&#125;|Holdings];</span><br><span class="line">        [H|T] -&gt;</span><br><span class="line">            <span class="keyword">case</span> H <span class="keyword">of</span></span><br><span class="line">                &#123;Stock, Amount&#125; -&gt;</span><br><span class="line">                    [&#123;Stock, Amount+<span class="number">1</span>&#125;|T];</span><br><span class="line">                _ -&gt;</span><br><span class="line">                    [H|add_stock(Stock, T)]</span><br><span class="line">            <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span>.</span><br><span class="line"></span><br><span class="line"><span class="comment">% get final Accounts and Offers</span></span><br><span class="line"><span class="comment">% Map_Reses = [[&#123;accept,AccountId,Offer&#125;...],...]</span></span><br><span class="line"><span class="function"><span class="title">run_all_Map_Res</span><span class="params">(Map_Reses,Accounts,Offers,Num)</span> -&gt;</span></span><br><span class="line">    <span class="keyword">case</span> Map_Reses <span class="keyword">of</span></span><br><span class="line">        [] -&gt;</span><br><span class="line">            &#123;Accounts,Offers,Num&#125;;</span><br><span class="line">        [Map_Res|T] -&gt;</span><br><span class="line">            OldNum = length(Offers),</span><br><span class="line">            &#123;NewMap_Res,NewAccounts&#125;= transfer_stock(Map_Res,Accounts),</span><br><span class="line">            NewOffers = remove_offer([NewMap_Res],Offers),</span><br><span class="line">            NewNum = length(NewOffers),</span><br><span class="line">            Num2 = Num + OldNum - NewNum,</span><br><span class="line">            run_all_Map_Res(T,NewAccounts,NewOffers,Num2)</span><br><span class="line">    <span class="keyword">end</span>.</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h2 id="Test-erlst-unit-erl"><a class="header-anchor" href="#Test-erlst-unit-erl">¶</a>Test_erlst_unit.erl</h2>
<figure class="highlight erlang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">-module</span><span class="params">(test_erlst_unit)</span>.</span><br><span class="line"></span><br><span class="line"><span class="keyword">-import</span><span class="params">(erlst, [launch/<span class="number">0</span>, open_account/<span class="number">2</span>, make_offer/<span class="number">2</span>, add_trader/<span class="number">2</span>, show/<span class="number">1</span>, run_all_traders/<span class="number">2</span>])</span>.</span><br><span class="line"><span class="keyword">-export</span><span class="params">([test_all/<span class="number">0</span>, test_everything/<span class="number">0</span>])</span>.</span><br><span class="line"><span class="keyword">-export</span><span class="params">([])</span>. <span class="comment">% Remember to export the other functions from Q2.2</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">-include_lib</span><span class="params">(<span class="string">&quot;eunit/include/eunit.hrl&quot;</span>)</span>.</span><br><span class="line"><span class="comment">% You are allowed to split your testing code in as many files as you</span></span><br><span class="line"><span class="comment">% think is appropriate, just remember that they should all start with</span></span><br><span class="line"><span class="comment">% &#x27;test_&#x27;.</span></span><br><span class="line"><span class="comment">% But you MUST have a module (this file) called test_erlst.</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">test_all</span><span class="params">()</span> -&gt;</span></span><br><span class="line">    [</span><br><span class="line">        &#123;<span class="string">&quot;EUnit&quot;</span>, spawn, [</span><br><span class="line">            test_start_server(),</span><br><span class="line">            test_shutdown(),</span><br><span class="line">            test_open_account(),</span><br><span class="line">            test_account_balance(),</span><br><span class="line">            test_make_offer(),</span><br><span class="line">            test_rescind_offer(),</span><br><span class="line">            test_add_trader()</span><br><span class="line">        ]&#125;</span><br><span class="line">    ].</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">test_everything</span><span class="params">()</span> -&gt;</span></span><br><span class="line">    eunit:test(test_all(), [verbose]).</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">test_start_server</span><span class="params">()</span> -&gt;</span></span><br><span class="line">  &#123;<span class="string">&quot;Start server&quot;</span>,</span><br><span class="line">    <span class="keyword">fun</span>() -&gt;</span><br><span class="line">      ?assertMatch(&#123;ok, _&#125;, erlst:launch())</span><br><span class="line">    <span class="keyword">end</span>&#125;.</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">test_shutdown</span><span class="params">()</span> -&gt;</span></span><br><span class="line">  &#123;<span class="string">&quot;Shutdown server&quot;</span>,</span><br><span class="line">    <span class="keyword">fun</span>() -&gt;</span><br><span class="line">      &#123;ok,S&#125; = erlst:launch(),</span><br><span class="line">      ?assertMatch(<span class="number">0</span>, erlst:shutdown(S))</span><br><span class="line">    <span class="keyword">end</span>&#125;.</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">test_open_account</span><span class="params">()</span> -&gt;</span></span><br><span class="line">    [</span><br><span class="line">        &#123;<span class="string">&quot;Open account acc1 and check balance&quot;</span>,</span><br><span class="line">        <span class="keyword">fun</span>() -&gt;</span><br><span class="line">          &#123;ok, S&#125; = erlst:launch(),</span><br><span class="line">          Acc1 = erlst:open_account(S, &#123;<span class="number">2000</span>, [&#123;<span class="string">&quot;a&quot;</span>, <span class="number">10</span>&#125;]&#125;),</span><br><span class="line">          B = erlst:account_balance(Acc1),</span><br><span class="line">          ?assertMatch(&#123;<span class="number">2000</span>,[&#123;<span class="string">&quot;a&quot;</span>,<span class="number">10</span>&#125;]&#125; , B)</span><br><span class="line">        <span class="keyword">end</span>&#125;,</span><br><span class="line">        &#123;<span class="string">&quot;Open acc with Holdings and check balance&quot;</span>, <span class="keyword">fun</span>() -&gt;</span><br><span class="line">        &#123;ok, S&#125; = erlst:launch(),</span><br><span class="line">        Holdings = &#123;<span class="number">100</span>, [&#123;<span class="string">&quot;a&quot;</span>, <span class="number">10</span>&#125;, &#123;<span class="string">&quot;b&quot;</span>, <span class="number">20</span>&#125;]&#125;,</span><br><span class="line">        Acc1 = erlst:open_account(S, Holdings),</span><br><span class="line">        B = erlst:account_balance(Acc1),</span><br><span class="line">        ?assertMatch(Holdings , B)</span><br><span class="line">        <span class="keyword">end</span>&#125;,</span><br><span class="line">      &#123;<span class="string">&quot;Open multipal accs&quot;</span>, <span class="keyword">fun</span>() -&gt;</span><br><span class="line">        &#123;ok, S&#125; = erlst:launch(),</span><br><span class="line">        Holdings = &#123;<span class="number">100</span>, [&#123;<span class="string">&quot;a&quot;</span>, <span class="number">10</span>&#125;, &#123;<span class="string">&quot;b&quot;</span>, <span class="number">20</span>&#125;]&#125;,</span><br><span class="line">        Acc1 = erlst:open_account(S, Holdings),</span><br><span class="line">        Acc2 = erlst:open_account(S, Holdings),</span><br><span class="line">        Acc3 = erlst:open_account(S, Holdings),</span><br><span class="line">        B1 = erlst:account_balance(Acc1),</span><br><span class="line">        B2 = erlst:account_balance(Acc2),</span><br><span class="line">        B3 = erlst:account_balance(Acc3),</span><br><span class="line">        erlst:show(S),</span><br><span class="line">        ?assertMatch(Holdings , B1),</span><br><span class="line">        ?assertMatch(Holdings , B2),</span><br><span class="line">        ?assertMatch(Holdings , B3)</span><br><span class="line">        <span class="keyword">end</span>&#125;,</span><br><span class="line">      &#123;<span class="string">&quot;Check negative ISK&quot;</span>, <span class="keyword">fun</span>() -&gt;</span><br><span class="line">          &#123;ok, S&#125; = erlst:launch(),</span><br><span class="line">          Holdings = &#123;-<span class="number">100</span>, [&#123;<span class="string">&quot;a&quot;</span>, <span class="number">10</span>&#125;, &#123;<span class="string">&quot;b&quot;</span>, <span class="number">20</span>&#125;]&#125;,</span><br><span class="line">          ?assertMatch(&#123;error, badHoldings&#125;, erlst:open_account(S, Holdings))</span><br><span class="line">      <span class="keyword">end</span>&#125;,</span><br><span class="line">      &#123;<span class="string">&quot;Check negative num&quot;</span>, <span class="keyword">fun</span>() -&gt;</span><br><span class="line">          &#123;ok, S&#125; = erlst:launch(),</span><br><span class="line">          Holdings = &#123;<span class="number">100</span>, [&#123;<span class="string">&quot;a&quot;</span>, -<span class="number">10</span>&#125;, &#123;<span class="string">&quot;b&quot;</span>, <span class="number">20</span>&#125;]&#125;,</span><br><span class="line">          ?assertMatch(&#123;error, badHoldings&#125;, erlst:open_account(S, Holdings))</span><br><span class="line">      <span class="keyword">end</span>&#125;</span><br><span class="line">    ].</span><br><span class="line">  </span><br><span class="line"><span class="function"><span class="title">test_account_balance</span><span class="params">()</span> -&gt;</span></span><br><span class="line">    &#123;<span class="string">&quot;Check balance of absent user&quot;</span>, <span class="keyword">fun</span>() -&gt;</span><br><span class="line">      erlst:launch(),</span><br><span class="line">      B = erlst:account_balance(&#123;&#123;<span class="number">1</span>,<span class="number">2</span>&#125;&#125;),</span><br><span class="line">      ?assertMatch(&#123;error,badAcct&#125; , B)</span><br><span class="line">    <span class="keyword">end</span>&#125;.</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">test_make_offer</span><span class="params">()</span> -&gt;</span></span><br><span class="line">  [&#123;<span class="string">&quot;Check make offer&quot;</span>,</span><br><span class="line">    <span class="keyword">fun</span>() -&gt;</span><br><span class="line">      &#123;ok, S&#125; = erlst:launch(),</span><br><span class="line">      Acc2 = erlst:open_account(S, &#123;<span class="number">2000</span>, []&#125;),</span><br><span class="line">      ?assertMatch(&#123;ok,_&#125;, erlst:make_offer(Acc2, &#123;<span class="string">&quot;a&quot;</span>, <span class="number">50</span>&#125;))</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123; <span class="string">&quot;Check make offer with negative num&quot;</span>,</span><br><span class="line">      <span class="keyword">fun</span>() -&gt;</span><br><span class="line">        &#123;ok, S&#125; = erlst:launch(),</span><br><span class="line">        Acc2 = erlst:open_account(S, &#123;<span class="number">2000</span>, []&#125;),</span><br><span class="line">        ?assertMatch(&#123;error, badPrice&#125;, erlst:make_offer(Acc2, &#123;<span class="string">&quot;a&quot;</span>, -<span class="number">50</span>&#125;))</span><br><span class="line">      <span class="keyword">end</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123; <span class="string">&quot;Check make offer with absent user&quot;</span>,</span><br><span class="line">      <span class="keyword">fun</span>() -&gt;</span><br><span class="line">        ?assertMatch(&#123;error, badAcct&#125;, erlst:make_offer(&#123;&#123;<span class="number">1</span>,<span class="number">2</span>&#125;&#125;, &#123;<span class="string">&quot;a&quot;</span>, <span class="number">50</span>&#125;))</span><br><span class="line">      <span class="keyword">end</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;<span class="string">&quot;Check make offer with not own stock&quot;</span>,</span><br><span class="line">      <span class="keyword">fun</span>() -&gt;</span><br><span class="line">        &#123;ok, S&#125; = erlst:launch(),</span><br><span class="line">        Acc2 = erlst:open_account(S, &#123;<span class="number">2000</span>, [&#123;<span class="string">&quot;b&quot;</span>, <span class="number">50</span>&#125;]&#125;),</span><br><span class="line">        ?assertMatch(&#123;ok, _&#125;, erlst:make_offer(Acc2, &#123;<span class="string">&quot;a&quot;</span>, <span class="number">50</span>&#125;))</span><br><span class="line">      <span class="keyword">end</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;<span class="string">&quot;Check make offer and reciend it&quot;</span>,</span><br><span class="line">      <span class="keyword">fun</span>() -&gt;</span><br><span class="line">        &#123;ok, S&#125; = erlst:launch(),</span><br><span class="line">        Acc2 = erlst:open_account(S, &#123;<span class="number">2000</span>, [&#123;<span class="string">&quot;a&quot;</span>, <span class="number">50</span>&#125;]&#125;),</span><br><span class="line">        Offer = erlst:make_offer(Acc2, &#123;<span class="string">&quot;a&quot;</span>, <span class="number">50</span>&#125;),</span><br><span class="line">        ?assertMatch(&#123;ok, _&#125;, Offer),</span><br><span class="line">        ?assertMatch(ok, erlst:rescind_offer(Acc2, Offer))</span><br><span class="line">      <span class="keyword">end</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;<span class="string">&quot;Check make offer and add trader and run it&quot;</span>,</span><br><span class="line">      <span class="keyword">fun</span>() -&gt;</span><br><span class="line">        &#123;ok, S&#125; = erlst:launch(),</span><br><span class="line">        Acc1 = erlst:open_account(S, &#123;<span class="number">2000</span>, [&#123;<span class="string">&quot;a&quot;</span>, <span class="number">50</span>&#125;]&#125;),</span><br><span class="line">        Acc2 = erlst:open_account(S, &#123;<span class="number">2000</span>, [&#123;<span class="string">&quot;a&quot;</span>, <span class="number">50</span>&#125;]&#125;),</span><br><span class="line">        Strategy = <span class="keyword">fun</span>(&#123;<span class="string">&quot;a&quot;</span>, Price&#125;) -&gt;</span><br><span class="line">            <span class="keyword">if</span></span><br><span class="line">                Price &lt; <span class="number">100</span> -&gt; accept;</span><br><span class="line">                <span class="literal">true</span> -&gt; reject</span><br><span class="line">            <span class="keyword">end</span></span><br><span class="line">        <span class="keyword">end</span>,</span><br><span class="line">        erlst:add_trader(Acc1, Strategy),</span><br><span class="line">        Offer = erlst:make_offer(Acc2, &#123;<span class="string">&quot;a&quot;</span>, <span class="number">50</span>&#125;),</span><br><span class="line">        ?assertMatch(&#123;ok, _&#125;, Offer),</span><br><span class="line">        timer:sleep(<span class="number">1000</span>),</span><br><span class="line">        ?assertMatch(&#123;<span class="number">1950</span>, [&#123;<span class="string">&quot;a&quot;</span>, <span class="number">51</span>&#125;]&#125;, erlst:account_balance(Acc1)),</span><br><span class="line">        ?assertMatch(&#123;<span class="number">2050</span>, [&#123;<span class="string">&quot;a&quot;</span>, <span class="number">49</span>&#125;]&#125;, erlst:account_balance(Acc2))</span><br><span class="line">      <span class="keyword">end</span></span><br><span class="line">    &#125;].</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">test_add_trader</span><span class="params">()</span> -&gt;</span></span><br><span class="line">  &#123;<span class="string">&quot;Add trader and check trader&quot;</span>,</span><br><span class="line">    <span class="keyword">fun</span>() -&gt;</span><br><span class="line">      &#123;ok, S&#125; = erlst:launch(),</span><br><span class="line">      Acc3 = erlst:open_account(S, &#123;<span class="number">2000</span>, [&#123;<span class="string">&quot;a&quot;</span>, <span class="number">2</span>&#125;]&#125;),</span><br><span class="line">      Acc4 = erlst:open_account(S, &#123;<span class="number">1000</span>, []&#125;),</span><br><span class="line">      Strategy = <span class="keyword">fun</span>(&#123;<span class="string">&quot;a&quot;</span>, Price&#125;) -&gt;</span><br><span class="line">            <span class="keyword">if</span></span><br><span class="line">                Price &lt; <span class="number">100</span> -&gt; accept;</span><br><span class="line">                <span class="literal">true</span> -&gt; reject</span><br><span class="line">            <span class="keyword">end</span></span><br><span class="line">        <span class="keyword">end</span>,</span><br><span class="line">      erlst:make_offer(Acc3, &#123;<span class="string">&quot;a&quot;</span>, <span class="number">50</span>&#125;),</span><br><span class="line">      erlst:add_trader(Acc4, Strategy),</span><br><span class="line">      timer:sleep(<span class="number">1000</span>),</span><br><span class="line">      ?assertMatch(&#123;<span class="number">2050</span>,[&#123;<span class="string">&quot;a&quot;</span>,<span class="number">1</span>&#125;]&#125;,erlst:account_balance(Acc3)),</span><br><span class="line">      ?assertMatch(&#123;<span class="number">950</span>,[&#123;<span class="string">&quot;a&quot;</span>,<span class="number">1</span>&#125;]&#125; ,erlst:account_balance(Acc4))</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    &#125;.</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">test_rescind_offer</span><span class="params">()</span> -&gt;</span></span><br><span class="line">  &#123;<span class="string">&quot;Rescind offer&quot;</span>,</span><br><span class="line">    <span class="keyword">fun</span>() -&gt;</span><br><span class="line">      &#123;ok, S&#125; = erlst:launch(),</span><br><span class="line">      Acc2 = erlst:open_account(S, &#123;<span class="number">2000</span>, [&#123;<span class="string">&quot;a&quot;</span>, <span class="number">50</span>&#125;]&#125;),</span><br><span class="line">      Offer = erlst:make_offer(Acc2, &#123;<span class="string">&quot;a&quot;</span>, <span class="number">50</span>&#125;),</span><br><span class="line">      ?assertMatch(&#123;ok, _&#125;, Offer),</span><br><span class="line">      ?assertMatch(ok, erlst:rescind_offer(Acc2, Offer))</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    &#125;.</span><br></pre></td></tr></table></figure>
<h2 id="Test-erlst-erl"><a class="header-anchor" href="#Test-erlst-erl">¶</a>Test_erlst.erl</h2>
<figure class="highlight erlang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">-module</span><span class="params">(test_erlst)</span>.</span><br><span class="line"></span><br><span class="line"><span class="keyword">-export</span><span class="params">([test_all/<span class="number">0</span>, test_everything/<span class="number">0</span>])</span>.</span><br><span class="line"><span class="comment">% -import(test_erlst_unit, [test_all/0, test_everything/0]).</span></span><br><span class="line"><span class="comment">% Remember to export the other functions from Q2.2</span></span><br><span class="line"><span class="keyword">-export</span><span class="params">([prop_value_preservation/<span class="number">0</span>, mkstrategy/<span class="number">1</span>, reliable_strategy/<span class="number">0</span>,prop_total_trades/<span class="number">0</span>])</span>.</span><br><span class="line"></span><br><span class="line"><span class="comment">% -compile(export_all).</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">-include_lib</span><span class="params">(<span class="string">&quot;eqc/include/eqc.hrl&quot;</span>)</span>.</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">test_all</span><span class="params">()</span> -&gt;</span></span><br><span class="line">    eqc:quickcheck(prop_value_preservation()),</span><br><span class="line">    eqc:quickcheck(prop_total_trades()),</span><br><span class="line">    test_erlst_unit:test_everything().</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">test_everything</span><span class="params">()</span> -&gt;</span></span><br><span class="line">    test_all().</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">mkstrategy</span><span class="params">(Opr)</span> -&gt;</span></span><br><span class="line">    <span class="keyword">case</span> Opr <span class="keyword">of</span></span><br><span class="line">        buy_everything -&gt;</span><br><span class="line">            <span class="keyword">fun</span>(&#123;_, _&#125;) -&gt; accept <span class="keyword">end</span>;</span><br><span class="line">        &#123;buy_cheap, Num&#125; -&gt;</span><br><span class="line">            <span class="keyword">fun</span>(&#123;_, Price&#125;) -&gt;</span><br><span class="line">                <span class="keyword">if</span></span><br><span class="line">                    Price =&lt; Num -&gt; accept;</span><br><span class="line">                    <span class="literal">true</span> -&gt; reject</span><br><span class="line">                <span class="keyword">end</span></span><br><span class="line">            <span class="keyword">end</span>;</span><br><span class="line">        &#123;buy_only, Stocks&#125; -&gt;</span><br><span class="line">            <span class="keyword">fun</span>(&#123;Stock, _&#125;) -&gt;</span><br><span class="line">                <span class="keyword">case</span> lists:member(Stock, Stocks) <span class="keyword">of</span></span><br><span class="line">                    <span class="literal">true</span> -&gt; accept;</span><br><span class="line">                    <span class="literal">false</span> -&gt; reject</span><br><span class="line">                <span class="keyword">end</span></span><br><span class="line">            <span class="keyword">end</span>;</span><br><span class="line">        &#123;both, S1, S2&#125; -&gt;</span><br><span class="line">            <span class="keyword">fun</span>(Offer) -&gt;</span><br><span class="line">                Str1 = mkstrategy(S1),</span><br><span class="line">                Str2 = mkstrategy(S2),</span><br><span class="line">                <span class="keyword">case</span> &#123;Str1(Offer), Str2(Offer)&#125; <span class="keyword">of</span></span><br><span class="line">                    &#123;accept, accept&#125; -&gt; accept;</span><br><span class="line">                    &#123;reject, reject&#125; -&gt; reject;</span><br><span class="line">                    _ -&gt; reject</span><br><span class="line">                <span class="keyword">end</span></span><br><span class="line">            <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span>.</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">stock_name</span><span class="params">()</span> -&gt;</span> eqc_gen:oneof([a,b,c,d,e,f]).</span><br><span class="line"><span class="function"><span class="title">stock_names</span><span class="params">()</span> -&gt;</span> eqc_gen:list(stock_name()).</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">stock_list</span><span class="params">()</span> -&gt;</span> </span><br><span class="line">    ?SUCHTHAT(&#123;_,Price&#125;,</span><br><span class="line">        &#123;stock_name(), eqc_gen:int()&#125;,</span><br><span class="line">        Price &gt; <span class="number">0</span>).</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">holdings</span><span class="params">()</span> -&gt;</span></span><br><span class="line">    ?SUCHTHAT(&#123;Money, _&#125;,</span><br><span class="line">              &#123;eqc_gen:int(), stock_list()&#125;,</span><br><span class="line">              Money &gt; <span class="number">0</span>).</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">offer</span><span class="params">()</span> -&gt;</span></span><br><span class="line">    ?SUCHTHAT(&#123;_,Price&#125;,</span><br><span class="line">          &#123;stock_name(), eqc_gen:int()&#125;,</span><br><span class="line">          Price &gt;= <span class="number">0</span>).</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">reliable_strategy</span><span class="params">()</span> -&gt;</span></span><br><span class="line">    oneof([</span><br><span class="line">            &#123;call, test_erlst, mkstrategy, [buy_everything]&#125;,</span><br><span class="line">            &#123;call, test_erlst, mkstrategy, [&#123;buy_cheap, int()&#125;]&#125;,</span><br><span class="line">            &#123;call, test_erlst, mkstrategy, [&#123;buy_only, stock_names()&#125;]&#125;,</span><br><span class="line">            &#123;call, test_erlst, mkstrategy, [&#123;both,&#123;buy_cheap,int()&#125;, &#123;buy_only, stock_names()&#125;&#125;]&#125;</span><br><span class="line">    ]).</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">calc_Total_Money</span><span class="params">(Accts)</span> -&gt;</span></span><br><span class="line">    <span class="keyword">case</span> Accts <span class="keyword">of</span></span><br><span class="line">        [] -&gt; <span class="number">0</span>;</span><br><span class="line">        [&#123;Balance,_&#125;|T] -&gt; <span class="keyword">case</span> Balance+<span class="number">0</span> <span class="keyword">of</span></span><br><span class="line">            <span class="number">0</span> -&gt; calc_Total_Money(T);</span><br><span class="line">            _ -&gt; Balance+calc_Total_Money(T)</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span>.</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">calc_Total_Stock</span><span class="params">(Accts)</span> -&gt;</span></span><br><span class="line">    <span class="keyword">case</span> Accts <span class="keyword">of</span></span><br><span class="line">        [] -&gt; <span class="number">0</span>;</span><br><span class="line">        &#123;_,Holdings&#125; -&gt; Holdings;</span><br><span class="line">        [&#123;_,Holdings&#125;|T] -&gt; <span class="keyword">case</span> Holdings <span class="keyword">of</span></span><br><span class="line">            [] -&gt; calc_Total_Stock(T);</span><br><span class="line">            [&#123;_,Num&#125;|T2] -&gt; Num+calc_Total_Stock(T);</span><br><span class="line">            &#123;_,Num&#125; -&gt; Num</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span>.</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">prop_value_preservation</span><span class="params">()</span> -&gt;</span></span><br><span class="line">    ?FORALL(</span><br><span class="line">        &#123;Strategy, Holdings1,Holdings2,Offer&#125;,</span><br><span class="line">        &#123;reliable_strategy(), holdings(),holdings(), offer()&#125;,</span><br><span class="line">        <span class="keyword">begin</span></span><br><span class="line">            &#123;ok,S&#125; = erlst:launch(),</span><br><span class="line">            A1 = erlst:open_account(S, Holdings1),</span><br><span class="line">            A2 = erlst:open_account(S, Holdings2),</span><br><span class="line">            erlst:make_offer(A1, Offer),</span><br><span class="line">            erlst:make_offer(A1, Offer),</span><br><span class="line">            erlst:make_offer(A1, Offer),</span><br><span class="line">            erlst:make_offer(A1, Offer),</span><br><span class="line">            erlst:make_offer(A2, Offer),</span><br><span class="line">            erlst:make_offer(A2, Offer),</span><br><span class="line">            erlst:make_offer(A2, Offer),</span><br><span class="line">            erlst:make_offer(A2, Offer),</span><br><span class="line">            A1Holding = erlst:account_balance(A1),</span><br><span class="line">            A2Holding = erlst:account_balance(A2),</span><br><span class="line">            Money1 = calc_Total_Money([A1Holding, A2Holding]),</span><br><span class="line">            Stock1 = calc_Total_Stock([A1Holding, A2Holding]),</span><br><span class="line">            erlst:add_trader(A1, eval(Strategy)),</span><br><span class="line">            erlst:add_trader(A1, eval(Strategy)),</span><br><span class="line">            erlst:add_trader(A1, eval(Strategy)),</span><br><span class="line">            erlst:add_trader(A1, eval(Strategy)),</span><br><span class="line">            erlst:add_trader(A2, eval(Strategy)),</span><br><span class="line">            erlst:add_trader(A2, eval(Strategy)),</span><br><span class="line">            erlst:add_trader(A2, eval(Strategy)),</span><br><span class="line">            erlst:add_trader(A2, eval(Strategy)),</span><br><span class="line">            A1Holding1 = erlst:account_balance(A1),</span><br><span class="line">            A2Holding1 = erlst:account_balance(A2),</span><br><span class="line">            Money2 = calc_Total_Money([A1Holding1, A2Holding1]),</span><br><span class="line">            Stock2 = calc_Total_Stock([A1Holding1, A2Holding1]),</span><br><span class="line">            eqc:equals(Money1, Money2),</span><br><span class="line">            eqc:equals(Stock1, Stock2)</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">    ).</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">prop_total_trades</span><span class="params">()</span> -&gt;</span></span><br><span class="line">    ?FORALL(</span><br><span class="line">        &#123;Strategy, Holdings1,Holdings2, Offer&#125;,</span><br><span class="line">        &#123;mkstrategy(buy_everything), holdings(), holdings(), offer()&#125;,</span><br><span class="line">        <span class="keyword">begin</span></span><br><span class="line">            &#123;ok,Pid&#125; = erlst:launch(),</span><br><span class="line">            A1 = erlst:open_account(Pid, Holdings1),</span><br><span class="line">            A2 = erlst:open_account(Pid, Holdings2),</span><br><span class="line">            erlst:make_offer(A1, Offer),</span><br><span class="line">            erlst:make_offer(A1, Offer),</span><br><span class="line">            erlst:make_offer(A1, Offer),</span><br><span class="line">            erlst:make_offer(A1, Offer),</span><br><span class="line">            erlst:make_offer(A2, Offer),</span><br><span class="line">            erlst:make_offer(A2, Offer),</span><br><span class="line">            erlst:make_offer(A2, Offer),</span><br><span class="line">            erlst:make_offer(A2, Offer),</span><br><span class="line">            erlst:add_trader(A2, Strategy),</span><br><span class="line">            erlst:add_trader(A2, Strategy),</span><br><span class="line">            erlst:add_trader(A2, Strategy),</span><br><span class="line">            erlst:add_trader(A2, Strategy),</span><br><span class="line">            erlst:add_trader(A1, Strategy),</span><br><span class="line">            erlst:add_trader(A1, Strategy),</span><br><span class="line">            erlst:add_trader(A1, Strategy),</span><br><span class="line">            erlst:add_trader(A1, Strategy),</span><br><span class="line">            Num = erlst:shutdown(Pid),</span><br><span class="line">            Num =&lt; <span class="number">8</span></span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">    ).</span><br><span class="line"></span><br></pre></td></tr></table></figure>

    </div>

    
    
    

    <footer class="post-footer">
          

<div class="post-copyright">
<ul>
  <li class="post-copyright-author">
      <strong>本文作者： </strong>Xuanlang
  </li>
  <li class="post-copyright-link">
      <strong>本文链接：</strong>
      <a href="https://www.zhaoxuanlang.cn/2023/01/30/Advanced-Programing-FinalReport/" title="Advanced-Programing-FinalReport">https://www.zhaoxuanlang.cn/2023/01/30/Advanced-Programing-FinalReport/</a>
  </li>
  <li class="post-copyright-license">
    <strong>版权声明： </strong>本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" rel="noopener" target="_blank"><i class="fab fa-fw fa-creative-commons"></i>BY-NC-SA</a> 许可协议。转载请注明出处！
  </li>
</ul>
</div>


        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/2023/01/30/ACS-Notes/" rel="prev" title="ACS-Notes">
                  <i class="fa fa-chevron-left"></i> ACS-Notes
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/2023/01/30/Machine-Learning-A-Final-Report/" rel="next" title="Machine-Learning-A-Final-Report">
                  Machine-Learning-A-Final-Report <i class="fa fa-chevron-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






    <div class="comments" id="SOHUCS" sid="9c16638c510e144b54101449130e6e5e"></div>
</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="beian"><a href="https://beian.miit.gov.cn/" rel="noopener" target="_blank">津ICP备19008018号-1 </a>
  </div>

<div class="copyright">
  &copy; 2019 – 
  <span itemprop="copyrightYear">2023</span>
  <span class="with-love">
    <i class="fa fa-award"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Xuanlang</span>
</div>

    </div>
  </footer>

  
  <script src="https://cdn.jsdelivr.net/npm/animejs@3.2.1/lib/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.js" integrity="sha256-yt2kYMy0w8AbtF89WXb2P1rfjcP/HTHLT7097U8Y5b8=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/lozad@1.16.0/dist/lozad.min.js" integrity="sha256-mOFREFhqmHeQbXpK2lp4nA3qooVgACfh88fpJftLBbc=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/pangu@4.0.7/dist/browser/pangu.min.js" integrity="sha256-j+yj56cdEY2CwkVtGyz18fNybFGpMGJ8JxG3GSyO2+I=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/schemes/muse.js"></script><script src="/js/next-boot.js"></script><script src="/js/bookmark.js"></script>

  
<script src="https://cdn.jsdelivr.net/npm/hexo-generator-searchdb@1.4.0/dist/search.js" integrity="sha256-vXZMYLEqsROAXkEw93GGIvaB2ab+QW6w3+1ahD9nXXA=" crossorigin="anonymous"></script>
<script src="/js/third-party/search/local-search.js"></script>



  <script src="/js/third-party/fancybox.js"></script>


  




  

  <script class="next-config" data-name="enableMath" type="application/json">false</script><script class="next-config" data-name="mathjax" type="application/json">{"enable":true,"tags":"none","js":{"url":"https://cdn.jsdelivr.net/npm/mathjax@3.2.0/es5/tex-mml-chtml.js","integrity":"sha256-r+3itOMtGGjap0x+10hu6jW/gZCzxHsoKrOd7gyRSGY="}}</script>
<script src="/js/third-party/math/mathjax.js"></script>


  <script src="https://cdn.jsdelivr.net/npm/quicklink@2.2.0/dist/quicklink.umd.js" integrity="sha256-4kQf9z5ntdQrzsBC3YSHnEz02Z9C1UeW/E9OgnvlzSY=" crossorigin="anonymous"></script>
  <script class="next-config" data-name="quicklink" type="application/json">{"enable":true,"home":true,"archive":true,"delay":true,"timeout":3000,"priority":true,"url":"https://www.zhaoxuanlang.cn/2023/01/30/Advanced-Programing-FinalReport/"}</script>
  <script src="/js/third-party/quicklink.js"></script>
<script class="next-config" data-name="changyan" type="application/json">{"enable":true,"appid":"cyvRiUJ7H","appkey":"bfa85e46b2e4cf46d837cbd6e78ba7ab"}</script>
<script src="/js/third-party/comments/changyan.js"></script>

</body>
</html>
